--- 
layout: post
title: Running Multiple Websites in a Windows Azure Web Role
categories: 
- Windows Azure
tags: []

status: publish
type: post
published: true
meta: 
  _edit_last: "1"
  disable_wpautop: "1"
  disable_wptexturize: "0"
  disable_convert_chars: "0"
  disable_convert_smilies: "0"
  _topsy_long_url: http://www.wadewegner.com/2011/02/running-multiple-websites-in-a-windows-azure-web-role/
  topsy_short_url: http://bit.ly/dPkKCd
  dsq_thread_id: "609465834"
---
<p>Prior to the release of the <a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=7a1089b6-4050-4307-86c4-9dadaa5ed018" target="_blank">Windows Azure 1.3 SDK</a>, Web roles hosted your application in <a href="http://technet.microsoft.com/en-us/library/cc735238(WS.10).aspx" target="_blank">IIS Hosted Web Core (HWC)</a>.&#160; While there were certainly ways to extend HWC, for the most part you were stuck with a single application bound to no more than a single HTTP or HTTPS endpoint.&#160; This model enabled only a minimal number of configurations, and prevented you from fully benefiting from the full capabilities of IIS.&#160; Here’s what the <strong>ServiceDefinition.csdef</strong> file looks like when using HWC:</p>  <pre class="code">  <span style="color: blue">&lt;?</span><span style="color: #a31515">xml </span><span style="color: red">version</span><span style="color: blue">=</span>&quot;<span style="color: blue">1.0</span>&quot; <span style="color: red">encoding</span><span style="color: blue">=</span>&quot;<span style="color: blue">utf-8</span>&quot;<span style="color: blue">?&gt;
  &lt;</span><span style="color: #a31515">ServiceDefinition </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">WindowsAzureProject15</span>&quot; 
     <span style="color: red">xmlns</span><span style="color: blue">=</span>&quot;<span style="color: blue">http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition</span>&quot;<span style="color: blue">&gt;
    &lt;</span><span style="color: #a31515">WebRole </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">WebRole1</span>&quot;<span style="color: blue">&gt;
      &lt;</span><span style="color: #a31515">Endpoints</span><span style="color: blue">&gt;
        &lt;</span><span style="color: #a31515">InputEndpoint </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Endpoint1</span>&quot; <span style="color: red">protocol</span><span style="color: blue">=</span>&quot;<span style="color: blue">http</span>&quot; <span style="color: red">port</span><span style="color: blue">=</span>&quot;<span style="color: blue">80</span>&quot; <span style="color: blue">/&gt;
      &lt;/</span><span style="color: #a31515">Endpoints</span><span style="color: blue">&gt;
      &lt;</span><span style="color: #a31515">Imports</span><span style="color: blue">&gt;
        &lt;</span><span style="color: #a31515">Import </span><span style="color: red">moduleName</span><span style="color: blue">=</span>&quot;<span style="color: blue">Diagnostics</span>&quot; <span style="color: blue">/&gt;
      &lt;/</span><span style="color: #a31515">Imports</span><span style="color: blue">&gt;
    &lt;/</span><span style="color: #a31515">WebRole</span><span style="color: blue">&gt;
  &lt;/</span><span style="color: #a31515">ServiceDefinition</span><span style="color: blue">&gt;
</span></pre>


<p>While you can still use this code today and run HWC in your Web role, you’ll miss you on a lot of great capabilities.</p>

<p>One of the capabilities that, surprisingly, people still doesn’t seem aware of in Windows Azure is the ability to <strong>run multiple websites in a Web Role</strong>.&#160; In fact, this capability is easy to add once we add seven additional lines of code.</p>

<pre class="code">  <span style="color: blue">&lt;?</span><span style="color: #a31515">xml </span><span style="color: red">version</span><span style="color: blue">=</span>&quot;<span style="color: blue">1.0</span>&quot; <span style="color: red">encoding</span><span style="color: blue">=</span>&quot;<span style="color: blue">utf-8</span>&quot;<span style="color: blue">?&gt;
  &lt;</span><span style="color: #a31515">ServiceDefinition </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">WindowsAzureProject15</span>&quot; 
     <span style="color: red">xmlns</span><span style="color: blue">=</span>&quot;<span style="color: blue">http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition</span>&quot;<span style="color: blue">&gt;
    &lt;</span><span style="color: #a31515">WebRole </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">WebRole1</span>&quot;<span style="color: blue">&gt;
      &lt;</span><span style="color: #a31515">Sites</span><span style="color: blue">&gt;
        &lt;</span><span style="color: #a31515">Site </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Web</span>&quot;<span style="color: blue">&gt;
          &lt;</span><span style="color: #a31515">Bindings</span><span style="color: blue">&gt;
            &lt;</span><span style="color: #a31515">Binding </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Endpoint1</span>&quot; <span style="color: red">endpointName</span><span style="color: blue">=</span>&quot;<span style="color: blue">Endpoint1</span>&quot; <span style="color: blue">/&gt;
          &lt;/</span><span style="color: #a31515">Bindings</span><span style="color: blue">&gt;
        &lt;/</span><span style="color: #a31515">Site</span><span style="color: blue">&gt;
      &lt;/</span><span style="color: #a31515">Sites</span><span style="color: blue">&gt;
      &lt;</span><span style="color: #a31515">Endpoints</span><span style="color: blue">&gt;
        &lt;</span><span style="color: #a31515">InputEndpoint </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Endpoint1</span>&quot; <span style="color: red">protocol</span><span style="color: blue">=</span>&quot;<span style="color: blue">http</span>&quot; <span style="color: red">port</span><span style="color: blue">=</span>&quot;<span style="color: blue">80</span>&quot; <span style="color: blue">/&gt;
      &lt;/</span><span style="color: #a31515">Endpoints</span><span style="color: blue">&gt;
      &lt;</span><span style="color: #a31515">Imports</span><span style="color: blue">&gt;
        &lt;</span><span style="color: #a31515">Import </span><span style="color: red">moduleName</span><span style="color: blue">=</span>&quot;<span style="color: blue">Diagnostics</span>&quot; <span style="color: blue">/&gt;
      &lt;/</span><span style="color: #a31515">Imports</span><span style="color: blue">&gt;
    &lt;/</span><span style="color: #a31515">WebRole</span><span style="color: blue">&gt;
  &lt;/</span><span style="color: #a31515">ServiceDefinition</span><span style="color: blue">&gt;
</span></pre>


<p>The difference here is found in lines <strong>#4</strong> through <strong>#10</strong>.&#160; We now have a <strong>&lt;Sites&gt;</strong> element that includes a default <strong>&lt;Site&gt; </strong>named “Web”.&#160; When run (locally or in Windows Azure), this translates into an actual web site running in IIS.</p>

<p><a href="http://images.wadewegner.com/wordpress/2011/11/Deployment.jpg"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="Deployment" border="0" alt="Deployment" src="http://images.wadewegner.com/wordpress/2011/11/Deployment_thumb.jpg" width="360" height="111" /></a></p>

<p>You can see that our website is now running in IIS.&#160; And what’s nice is that the syntax used in the <strong>ServiceDefinition.csdef </strong>file is nearly identical to how this is traditionally accomplished in the <a href="http://www.iis.net/ConfigReference/system.applicationHost/sites" target="_blank"><strong>system.applicationHost</strong></a> – there’s not much new we have to learn.</p>

<p><strong><font size="4">Run the Same Project in Two Sites in the Web Role</font></strong></p>

<p>So, how can we take this further and run a second website in a Web role?&#160; It’s as simple as adding an additional <strong>&lt;Site&gt;</strong> to the <strong>&lt;Sites&gt;</strong> element.</p>

<p>Copy lines <strong>#5</strong> through <strong>#9 </strong>above, and past them below line <strong>#9</strong>.&#160; You’re going to have to make a few updates:</p>

<ol>
  <li>Change the site name.&#160; You can’t have multiple sites with the same name. </li>

  <li>You’ll have to specify a physical directory for the second site. </li>
</ol>

<blockquote>
  <p><strong>Note:</strong> the only reason we don’t have to specify a physical path for the first site is because “Web” is consider a special case, and Visual Studio knows that it’s referring to the path of the Web role project.&#160; You can confirm this by renaming “Web” to “Web1” – once you do this you’ll have to specify a physical path for the site.</p>
</blockquote>

<ol>
  <li>Create a host header entry for the binding element.&#160; The reason for this is because both sites are listening on port 80.&#160; This is the same behavior you’ll find in IIS – you cannot have more than one site listening on the same port without adding a host header. </li>
</ol>

<p>Once you make these modifications, your &lt;Sites&gt; element will look something like this:</p>

<pre class="code">  <span style="color: blue">&lt;</span><span style="color: #a31515">Sites</span><span style="color: blue">&gt;
    &lt;</span><span style="color: #a31515">Site </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Web</span>&quot;<span style="color: blue">&gt;
      &lt;</span><span style="color: #a31515">Bindings</span><span style="color: blue">&gt;
        &lt;</span><span style="color: #a31515">Binding </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Endpoint1</span>&quot; <span style="color: red">endpointName</span><span style="color: blue">=</span>&quot;<span style="color: blue">Endpoint1</span>&quot; <span style="color: blue">/&gt;
      &lt;/</span><span style="color: #a31515">Bindings</span><span style="color: blue">&gt;
    &lt;/</span><span style="color: #a31515">Site</span><span style="color: blue">&gt;
    &lt;</span><span style="color: #a31515">Site </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Web2</span>&quot; <span style="color: red">physicalDirectory</span><span style="color: blue">=</span>&quot;<span style="color: blue">..\WebRole1</span>&quot;<span style="color: blue">&gt;
      &lt;</span><span style="color: #a31515">Bindings</span><span style="color: blue">&gt;
        &lt;</span><span style="color: #a31515">Binding </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Endpoint1</span>&quot; <span style="color: red">endpointName</span><span style="color: blue">=</span>&quot;<span style="color: blue">Endpoint1</span>&quot; <span style="color: red">hostHeader</span><span style="color: blue">=</span>&quot;<span style="color: blue">www.litware.com</span>&quot; <span style="color: blue">/&gt;
      &lt;/</span><span style="color: #a31515">Bindings</span><span style="color: blue">&gt;
    &lt;/</span><span style="color: #a31515">Site</span><span style="color: blue">&gt;
  &lt;/</span><span style="color: #a31515">Sites</span><span style="color: blue">&gt;
</span></pre>


<p>While this syntax is correct, <a href="http://www.litware.com">www.litware.com</a> will not locally resolve to our application.&#160; To make this work, we have to update our hosts file to assist in correctly resolving the address to 127.0.0.1 (the loopback address). Update the hosts file (C:WindowsSystem32driversetchosts) to include the following hostnames:</p>

<pre class="code">127.0.0.1 www.fabrikam.com
127.0.0.1 www.contoso.com
127.0.0.1 www.litware.com</pre>


<p>After you’ve done this, you can confirm that they’re resolving correctly by pinging one of the addresses:</p>

<p><a href="http://images.wadewegner.com/wordpress/2011/02/image3.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2011/02/image_thumb3.png" width="430" height="219" /></a></p>

<p>The reply should come from 127.0.0.1.</p>

<p>With this complete, hit <strong>F5</strong> and run again.&#160; You’re now running the same project in two different websites – take a look at IIS:</p>

<p><a href="http://images.wadewegner.com/wordpress/2011/02/image4.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2011/02/image_thumb4.png" width="362" height="119" /></a></p>

<p>In fact, if you take a look at the bindings on <strong>Web2</strong>, you’ll see that the host name has been set to <a href="http://www.litware.com">www.litware.com</a>.</p>

<p><a href="http://images.wadewegner.com/wordpress/2011/02/image5.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2011/02/image_thumb5.png" width="457" height="191" /></a></p>

<p>And if you type <a title="http://www.litware.com:81/" href="http://www.litware.com:81/">http://www.litware.com:81/</a> (or whatever port the compute emulator is using), you’ll see the website display.</p>

<p><a href="http://images.wadewegner.com/wordpress/2011/02/image6.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2011/02/image_thumb6.png" width="430" height="274" /></a></p>

<p>This is pretty cool, especially when want to use the same application for multiple websites – you can handle the requests in such a way that you either pull from different databases or even display different CSS files to make the website display differently.</p>

<blockquote>
  <p><strong>Note:</strong> Some of you may have noticed above that IIS showed <a href="http://www.litware.com">www.litware.com</a> as running under port 5100.&#160; You may be wondering why it’s not on port 81, which is what we’re browsing to in IE.&#160; This is because it’s the compute emulator that’s listening on port 81, and then routing to port 5100.&#160; This is necessary so that incase we’re running more than one instance of our web application, both of which have the same host header, they’re not running on the same port.&#160; Nifty, eh?</p>
</blockquote>

<p>Now we can even go further.&#160; Let’s take a look at how we can take a completely separate web application and run it in the same Web role.</p>

<p><strong><font size="4">Run Two Different Projects in the Web Role</font></strong></p>

<p>Open up a new instance of Visual Studio 2010, and create a new Web Application.&#160; I’d recommend you make a few changes to make it easily recognizable (e.g. change “Welcome to ASP.NET!” to something else).&#160; Be sure to <strong>Build</strong> your solution (failure to do this will cause problems later).&#160; Copy the <strong>Project Folder</strong> for the project, and then return to the <strong>ServiceDefinition.csdef</strong> file in your Windows Azure project.</p>

<p>Create a new <strong>&lt;Site&gt;</strong> element where the <strong>physicalDirectory</strong> value is the location of the <strong>Project Folder</strong> you copied a moment ago.&#160; Also, update the site name and the <strong>hostHoder</strong>.&#160; It should look something like this:</p>

<pre class="code">  <span style="color: blue">&lt;</span><span style="color: #a31515">Site </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Web3</span>&quot; <span style="color: red">physicalDirectory</span><span style="color: blue">=</span>&quot;<span style="color: blue">c:\\Projects\\WebApplication7\\WebApplication7</span>&quot;<span style="color: blue">&gt;
    &lt;</span><span style="color: #a31515">Bindings</span><span style="color: blue">&gt;
      &lt;</span><span style="color: #a31515">Binding </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Endpoint1</span>&quot; <span style="color: red">endpointName</span><span style="color: blue">=</span>&quot;<span style="color: blue">Endpoint1</span>&quot; <span style="color: red">hostHeader</span><span style="color: blue">=</span>&quot;<span style="color: blue">www.fabrikam.com</span>&quot; <span style="color: blue">/&gt;
    &lt;/</span><span style="color: #a31515">Bindings</span><span style="color: blue">&gt;
  &lt;/</span><span style="color: #a31515">Site</span><span style="color: blue">&gt;
</span></pre>


<p>We’ve now create a third website, but this time – instead of pointing to the Web role project in our solution – we’ve pointed to a completely separate project that lives outside of our solution.&#160; Hit F5 and take a look at IIS:</p>

<p><a href="http://images.wadewegner.com/wordpress/2011/02/image7.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2011/02/image_thumb7.png" width="362" height="135" /></a></p>

<p>We now have three sites running, the third which includes the files from “WebApplication7”.&#160; Try it out by updating the URL to <a title="http://www.fabrikam.com:81/" href="http://www.fabrikam.com:81/">http://www.fabrikam.com:81/</a> and you’ll see:</p>

<p><a href="http://images.wadewegner.com/wordpress/2011/02/image8.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2011/02/image_thumb8.png" width="430" height="274" /></a></p>

<p>You can see that this is the not the Web role project itself, but the second project we created.&#160; The packaging tools know to include all the files needed from the <strong>physicalDirectory</strong> location and make them a part of the CSPKG that is ultimately given to the fabric controller.</p>

<p>This is pretty awesome, cause it demonstrates that you can run two completely different websites in the same Web role with a minimal amount of work.</p>

<p>Now, let’s take this even one step further … because we can.</p>

<p><strong><font size="4">Run a Virtual Application Within a Site</font></strong></p>

<p>There may be times when you want to run a <strong>Virtual Application</strong> within your site (see <a href="http://blogs.msdn.com/b/wenlong/archive/2006/11/22/virtual-application-vs-virtual-directory.aspx" target="_blank">Wenlong Dong’s post Virtual Application vs Virtual Directory</a> for some interesting information).&#160; Given that the semantics of the &lt;Sites&gt; element is similar to system.applicationHost, it’s not hard to accomplish.</p>

<p>Create a brand new <strong>Web Application</strong>, and this time update <strong>&lt;h2&gt;</strong> with a different description (e.g. “This is my virtual application!”).&#160; Build the solution, then grab the project’s path.&#160; Return to your Windows Azure project and the <strong>ServiceDefinition.csdef </strong>file.&#160; We’re going to add this virtual application to the “Web3” site.&#160; We do this by adding a <strong>&lt;VirtualApplication&gt;</strong> element with name and <strong>physicalDirectory</strong> values.&#160; Here’s what it will look like:</p>

<pre class="code">  <span style="color: blue">&lt;</span><span style="color: #a31515">Site </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Web3</span>&quot; 
        <span style="color: red">physicalDirectory</span><span style="color: blue">=</span>&quot;<span style="color: blue">c:\\Projects\\WebApplication7\\WebApplication7</span>&quot;<span style="color: blue">&gt;
    &lt;</span><span style="color: #a31515">VirtualApplication </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">VirtualApp</span>&quot; 
        <span style="color: red">physicalDirectory</span><span style="color: blue">=</span>&quot;<span style="color: blue">c:\\Projects\\WebApplication8\\WebApplication8</span>&quot; <span style="color: blue">/&gt;
    &lt;</span><span style="color: #a31515">Bindings</span><span style="color: blue">&gt;
      &lt;</span><span style="color: #a31515">Binding </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">Endpoint1</span>&quot; <span style="color: red">endpointName</span><span style="color: blue">=</span>&quot;<span style="color: blue">Endpoint1</span>&quot; <span style="color: red">hostHeader</span><span style="color: blue">=</span>&quot;<span style="color: blue">www.fabrikam.com</span>&quot; <span style="color: blue">/&gt;
    &lt;/</span><span style="color: #a31515">Bindings</span><span style="color: blue">&gt;
  &lt;/</span><span style="color: #a31515">Site</span><span style="color: blue">&gt;
</span></pre>


<p>The <strong>&lt;VirtualApplication&gt;</strong> element is on line <strong>#3</strong>.&#160; Go ahead and hit F5, and take a look at IIS:</p>

<p><a href="http://images.wadewegner.com/wordpress/2011/02/image9.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2011/02/image_thumb9.png" width="362" height="272" /></a></p>

<p>You can see that now, in Web3, our virtual application called <strong>VirtualApp</strong> is running.&#160; And if we browse to <a title="http://www.fabrikam.com:81/virtualapp/" href="http://www.fabrikam.com:81/virtualapp/">http://www.fabrikam.com:81/virtualapp/</a>, we’ll see that it is indeed “WebApplication8” that’s running.</p>

<p><a href="http://images.wadewegner.com/wordpress/2011/02/image10.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2011/02/image_thumb10.png" width="430" height="274" /></a></p>

<p>So there you have it!</p>

<p>You’ve now seen how to:</p>

<ol>
  <li>Run multiple websites that run off of the same project in the same Web role. </li>

  <li>Run multiple websites that use different projects in the same Web role. </li>

  <li>Run a virtual application within a website that uses a different project in a Web role. </li>
</ol>

<p>Of course, when you deploy this to Windows Azure, you’ll want to use your own domain name and set the host headers accordingly.&#160; For tips on how to do this – especially as as it relates to setting up CNAMEs for your domain – take a look at Steve Marx’s post on <a href="http://blog.smarx.com/posts/custom-domain-names-in-windows-azure" target="_blank">Custom Domain Names in Windows Azure</a>.</p>
