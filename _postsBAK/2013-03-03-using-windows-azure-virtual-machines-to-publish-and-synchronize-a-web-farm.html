--- 
layout: post
title: Using Windows Azure Virtual Machines to Publish and Synchronize a Web Farm
categories: 
- IAAS
- PowerShell
- Virtual Machine
- Web Deploy
- Windows Azure
tags: []

status: publish
type: post
published: true
meta: 
  _wpas_done_all: "1"
  _topsy_long_url: http://www.wadewegner.com/2013/03/using-windows-azure-virtual-machines-to-publish-and-synchronize-a-web-farm/
  topsy_short_url: http://bit.ly/XNbXZw
  dsq_thread_id: "1116644831"
---
<p>Lately I’ve been attempting to try out a number of different techniques for publishing web applications – both websites and web APIs – to the cloud. I’m being purposely vague when saying “the cloud” – it could be Windows Azure, AWS, or even a traditional hosting provider. It’s likely you saw a <a href="http://michaelwasham.com/2012/08/13/publishing-and-synchronizing-web-farms-using-windows-azure-virtual-machines/" target="_blank">great post by Michael Washam</a> that provides a solution for using Windows Azure virtual machines along with Web Deploy and a few PowerShell scripts. What’s below is a technique adapted from Michael’s post and detailed for each of the steps. What I like about this approach is that, aside from the machine preparation, the deployment technique is consistent across different platforms.  <p>There are certainly a few things missing below: scripts for scaling up/down, scripts for running Windows update, and so forth. I’ll tackle these in future posts. My point here is to highlight a different way to look at tackling a common problem.</p> <p>What are some of the advantages to this approach?</p> <ul> <li>Near instant deployment.  <li>Fully automated.  <li>Consistent development model with other platforms.  <li>Consistent deployment model with other platforms.</li></ul> <p>I’m sure there are more. There are some limitations as well – in particular, you’re bound by the number of roles you can have in your Cloud Service, which today is (I think) 25. This means that, at most, you can only scale out to 25 virtual machines. I imagine this limitation will be removed at some point (or perhaps you could get around it by using virtual networks).</p> <p>Regardless, give it a try.</p> <p><strong>Note</strong>: You can find the PowerShell scripts used below in this gist here: <a title="https://gist.github.com/wadewegner/5080142" href="https://gist.github.com/wadewegner/5080199">https://gist.github.com/wadewegner/5080142</a>.</p> <p><strong><u><font size="4">Image Preparation</font></u></strong></p> <p>In this first step you’ll create and customize a virtual machine that you’ll then sysprep and turn into a disk that we’ll use later on.  <h5><u>Create the Base Virtual Machine</u></h5> <p>This first part takes the longest. This is because you’re preparing the disk you’ll use moving forward. Note that you only do it once – this is not something you have to do over and over again.  <p>1. Create a Virtual Machine.<br>&nbsp;<a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="WAIIASImage1" border="0" alt="WAIIASImage1" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb.png" width="252" height="59"></a>  <p>2. Enter the VM information. Use the default “Windows Server 2012 Datacenter” image. Size doesn’t matter. This VM will sysprepped and used as a disk image for creating future virtual machines.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_3.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="WAIIASImage2" border="0" alt="WAIIASImage2" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_3.png" width="370" height="336"></a></p> <ul> <li>Be sure to note the location you use.  <li>Be sure and remember the password. You’ll need it. </li></ul> <p>3. Start the VM.</p> <ul> <li>Note: Notice that VMs create a Cloud Service. Each VM is actually a role within </li></ul> <p>4. RDP into the VM once it has provisioned and started.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_4.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="WAIIASImage3" border="0" alt="WAIIASImage3" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_4.png" width="73" height="57"></a> </p> <p>5. Click to <b>Add roles and features</b>.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_5.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_5.png" width="340" height="145"></a>  <p>6. Leave defaults and click <b>Next</b> until you get to Server Roles.  <p>7. Choose <b>Application Server</b> and <b>Web Server (IIS)</b>. Click <b>Next</b>.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_6.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_6.png" width="624" height="442"></a>  <p>8. Under <b>Features</b> be sure to select <b>ASP.NET 4.5</b>.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_7.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_7.png" width="347" height="88"></a>  <p>9. Click <b>Next</b> until you get to <b>Role Services</b> under <b>Web Server Role (IIS).</b></p> <p>10. Add <b>ASP.NET 4.5</b> under <b>Application Development</b>. This will add the other default values.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_8.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_8.png" width="348" height="217"></a> </p> <p>11. Click <b>Next</b> until you get to the last step. Click <b>Install</b>. Wait until the operation completes.  <p><strong><u>Install and Use Windows Azure PowerShell Cmdlets</u></strong></p> <p>12. From the machine, download the Windows Azure PowerShell Cmdlets. These can be found at: <a href="http://www.windowsazure.com/en-us/downloads/">http://www.windowsazure.com/en-us/downloads/</a>.  <p>13. Install the cmdlets. This can take 5-15 minutes.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_9.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_9.png" width="624" height="428"></a>  <p>14. Create the folder <b>c:&#92;&#92;Scripts</b>.  <p>15. Run the following script in <b>Windows PowerShell ISE</b> to download your publish settings file:</p> <p>Get-AzurePublishSettingsFile </p> <p>16. Save or move this file into the <b>c:&#92;&#92;Scripts</b> folder and rename to <b>credentials.publishsettings</b>.  <p>17. Run the following script in <b>Windows PowerShell ISE</b> to change the execution policy:<br>Set-ExecutionPolicy Unrestricted  <p><strong><u>Setup Web Deploy</u></strong></p> <p>18. Download <b>Web Deploy 3.0</b> from the following link: <a href="http://download.microsoft.com/download/1/B/3/1B3F8377-CFE1-4B40-8402-AE1FC6A0A8C3/WebDeploy_amd64_en-US.msi">http://download.microsoft.com/download/1/B/3/1B3F8377-CFE1-4B40-8402-AE1FC6A0A8C3/WebDeploy_amd64_en-US.msi</a>. <b>Do not install</b>. To simplify, download to C:&#92;&#92;.  <p>19. Open a <b>Command Prompt</b>.  <p>20. Run the following command:  <p><font size="2"><font face="Courier New">C:&#92;&#92;&gt;msiexec /I webdeploy_amd64_en-us.msi /passive ADDLOCAL=ALL LISTENURL=http://+:8080/</font><br></font><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_10.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_10.png" width="626" height="315"></a> </p> <p><strong><u>Configure Firewall Settings</u></strong></p> <p>21. Run <b>Windows Firewall with Advanced Security</b>.  <p>22. Select <b>Inbound Rules</b> and click <b>New Rule</b>.  <p>23. Select <b>Port</b> and click <b>Next</b>.  <p>24. Level TCP selected and enter <b>8080</b> for the <b>Specific local ports</b>.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_11.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_11.png" width="624" height="504"></a>  <p>25. Keep the defaults and click <b>Next</b> until prompted to give a name. Choose a name (e.g. Web Deploy Port) and click <b>Finish</b>.  <p><strong><u>System Preparation</u></strong></p> <p>26. Open a <b>Command Prompt</b> as an administrator.  <p>27. Change the directory to: <font face="Courier New">%windir%&#92;&#92;system32&#92;&#92;sysprep</font>  <p>28. Run <b>sysprep.exe</b>.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_12.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_12.png" width="626" height="429"></a>  <p>29. Ensure the following options are selected:  <ul> <li>Enter System Out-of-Box Experience (OOBE)  <li>Generalize  <li>Shutdown<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_13.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_13.png" width="354" height="267"></a> </li></ul> <p><strong><u>Capture the Virtual Machine</u></strong></p> <p>30. Return to your Virtual Machine Instances tab in the portal: <a href="https://manage.windowsazure.com/#Workspace/VirtualMachineExtension/vms">https://manage.windowsazure.com/#Workspace/VirtualMachineExtension/vms</a>.  <p>31. Wait until you see that the status of your virtual machine is <b>Stopped</b>.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_14.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_14.png" width="626" height="78"></a>  <p>32. Capture the image by clicking the <b>CAPTURE</b> button below.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/clip_image024.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="clip_image024" border="0" alt="clip_image024" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/clip_image024_thumb.png" width="113" height="78"></a>  <p>33. Select an image name (e.g. WS2012-WebFarmImage) and check that you have sysprepped the machine. Click the button.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_15.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_15.png" width="524" height="411"></a>  <p>34. When the capture operation completes you’ll see the disk image available under <b>Images</b> in the portal: <a href="https://manage.windowsazure.com/#Workspaces/VirtualMachineExtension/images">https://manage.windowsazure.com/#Workspaces/VirtualMachineExtension/images</a>  <p><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_16.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_16.png" width="576" height="95"></a>  <p><strong><u><font size="4">Virtual Machine Deployment</font></u></strong></p> <p>You’ll run these steps from your own PC.  <p>1. Open the <b>Windows PowerShell ISE</b> to run the following scripts. It’s always a good idea to save them somewhere to use later.  <p>2. You might need to import your publish settings. If so, download your publish settings file, save it, then import it.</p> <p><font size="2" face="Courier New">Get-AzurePublishSettingsFile</font></p> <p><font size="2" face="Courier New">Import-AzurePublishSettingsFile C:&#92;&#92;credentials.publishsettings</font> </p> <p>3. Get the subscription name to which you’ll deploy. Run the following script:</p> <p><font size="2" face="Courier New">Get-AzureSubscription -Current</font><br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_17.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_17.png" width="525" height="73"></a> </p> <p>4. You need to get the storage account that contains your disk image. You’ll need to use the same storage account for the disks attached to the web servers in your web farm. Select the <b>Images</b> tab under <b>Virtual Machines</b> on the portal. Find your image and look at the location. The first part of the URL is the storage account name.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_18.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_18.png" width="341" height="98"></a> </p> <p>5. It’s now time to deploy your web farm using the disk image you created in the previous section. Review the following script and update appropriately. <pre class="code"><span style="color: black">$imgname = </span><span style="color: #a31515">'WS2012-WebFarmImage'
</span><span style="color: black">$cloudsvc = </span><span style="color: #a31515">'DemoWebFarm'
</span><span style="color: black">$pass = </span><span style="color: #a31515">'Password'
</span><span style="color: black">$subscriptionName = </span><span style="color: #a31515">'Windows Azure MSDN - Visual Studio Ultimate'
</span><span style="color: black">$storageAccount = </span><span style="color: #a31515">'portalvhds9dvbvvff5hdg3'
</span><span style="color: black">$location = </span><span style="color: #a31515">'East US'

</span><span style="color: black">Set-AzureSubscription -SubscriptionName $subscriptionName -CurrentStorageAccount $storageAccount

$iisvm1 = New-AzureVMConfig -Name </span><span style="color: #a31515">'iis1' </span><span style="color: black">-InstanceSize Small -ImageName $imgname |
    Add-AzureEndpoint -Name web -LocalPort 80 -PublicPort 80 -Protocol tcp -LBSetName web -ProbePath </span><span style="color: #a31515">'/' </span><span style="color: black">-ProbeProtocol http -ProbePort 80 |
    Add-AzureEndpoint -Name webdeploy -LocalPort 8080 -PublicPort 8080 -Protocol tcp | 
    Add-AzureProvisioningConfig -Windows -Password $pass
    
$iisvm2 = New-AzureVMConfig -Name </span><span style="color: #a31515">'iis2' </span><span style="color: black">-InstanceSize Small -ImageName $imgname |
    Add-AzureEndpoint -Name web -LocalPort 80 -PublicPort 80 -Protocol tcp -LBSetName web -ProbePath </span><span style="color: #a31515">'/' </span><span style="color: black">-ProbeProtocol http -ProbePort 80 |
    Add-AzureProvisioningConfig -Windows -Password $pass
    
$iisvm3 = New-AzureVMConfig -Name </span><span style="color: #a31515">'iis3' </span><span style="color: black">-InstanceSize Small -ImageName $imgname |
    Add-AzureEndpoint -Name web -LocalPort 80 -PublicPort 80 -Protocol tcp -LBSetName web -ProbePath </span><span style="color: #a31515">'/' </span><span style="color: black">-ProbeProtocol http -ProbePort 80 |
    Add-AzureProvisioningConfig -Windows -Password $pass    
    
New-AzureVM -ServiceName $cloudsvc -VMs $iisvm1, $iisvm2, $iisvm3 -Location $location</span></pre>
<p>Notes on script: 
<ul>
<li><b>$imgname</b>: This is the name of the disk image you created. 
<li><b>$cloudsvc</b>: When you deploy it will create a cloud service. This is the name for the cloud service. 
<li><b>$pass</b>: This is the password for the virtual machine you created. 
<li><b>$subscriptionName</b>: This is your subscription name. 
<li><b>$location</b>: The datacenter you want to deploy into. Note: this has to be the same data center as your storage account. </li></ul>
<p>It is <u>important</u> to note that the setup for $iisvm1 is different than $iisvm2 and $iisvm3. That’s because we’re adding an additional endpoint named <b>webdeploy</b> on 8080. We’ll use this public port for deploying via web deploy. It is not opened on the other machines. 
<p>6. It’s time to run the script. Note: the script does not rollback. If you have values that are incorrect you’ll have to clean them up manually. If all goes well, you’ll see progress indicators like the following:<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_19.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_19.png" width="606" height="268"></a><br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_20.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_20.png" width="529" height="116"></a> 
<p>7. You can now look in the portal and you’ll see the following machines Running/Provisioning.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_21.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_21.png" width="626" height="232"></a> 
<p>8. You can browse the URL, for example: <a href="http://demowebfarm.cloudapp.net">http://demowebfarm.cloudapp.net</a>. You’ll get the standard IIS page:<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_22.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_22.png" width="626" height="340"></a> 
<p><strong><u><font size="4">Setup Synchronization across Virtual Machines</font></u></strong></p>
<p>1. Remote into <b>iis1</b>. From the portal, select <b>iis1</b> under <b>Virtual Machine Instances</b> and click the <b>CONNECT</b> button. This will download an RDP file. Save this and use it for connecting to the machine later.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/clip_image039.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="clip_image039" border="0" alt="clip_image039" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/clip_image039_thumb.png" width="67" height="66"></a> 
<p>2. Open <b>Windows PowerShell ISE</b>. 
<p>3. Click <b>New</b> to create a new script. 
<p>4. Copy the following script and save it as <b>C:&#92;&#92;Scripts&#92;&#92;Sync.ps1</b>. DO NOT RUN IT.<pre class="code"><span style="color: black">$subscriptionName = </span><span style="color: #a31515">'Windows Azure MSDN - Visual Studio Ultimate'
</span><span style="color: black">$storageAccount = </span><span style="color: #a31515">'portalvhds9dvbvvff5hdg3'
</span><span style="color: black">$cloudsvc = </span><span style="color: #a31515">' DemoWebFarm' 
</span><span style="color: black">$publishSettings = </span><span style="color: #a31515">'C:&#92;&#92;Scripts&#92;&#92;credentials.publishsettings'

</span><span style="color: black">Import-Module </span><span style="color: #a31515">'C:&#92;&#92;Program Files (x86)&#92;&#92;Microsoft SDKs&#92;&#92;Windows Azure&#92;&#92;PowerShell&#92;&#92;Azure&#92;&#92;Azure.psd1'

</span><span style="color: black">Import-AzurePublishSettingsFile $publishSettings
Set-AzureSubscription -SubscriptionName $subscriptionName -CurrentStorageAccount $storageAccount

$publishingServer = (gc env:computername).toLower()

Get-AzureVM -ServiceName $cloudsvc | </span><span style="color: blue">foreach </span><span style="color: black">{ 
    </span><span style="color: blue">if </span><span style="color: black">($_.Name.toLower() -ne $publishingServer) {
       $target = $_.Name + </span><span style="color: #a31515">":8080"
       </span><span style="color: black">$source = $publishingServer + </span><span style="color: #a31515">":8080"

       </span><span style="color: black">$exe = </span><span style="color: #a31515">"C:&#92;&#92;Program Files&#92;&#92;IIS&#92;&#92;Microsoft Web Deploy V3&#92;&#92;msdeploy.exe"
       </span><span style="color: black">[Array]$</span><span style="color: blue">params </span><span style="color: black">= </span><span style="color: #a31515">"-verb:sync"</span><span style="color: black">, </span><span style="color: #a31515">"-source:contentPath=C:&#92;&#92;Inetpub&#92;&#92;wwwroot,computerName=$source"</span><span style="color: black">, </span><span style="color: #a31515">"-dest:contentPath=C:&#92;&#92;Inetpub&#92;&#92;wwwroot,computerName=$target"</span><span style="color: black">;

        &amp; $exe $</span><span style="color: blue">params</span><span style="color: black">;
    }   
}</span></pre><strong><u><font size="4">
<p><br>Create a Scheduled Task</font></u></strong></p>
<p>5. Open <b>Task Scheduler</b>. </p>
<p>6. Click <b>Create Task …<br></b><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_23.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_23.png" width="624" height="445"></a><b><br></b>
<p>7. On the <b>General </b>tab set the <b>Name</b> and <b>Run wehather user is logged on or not</b>.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_24.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_24.png" width="624" height="470"></a> 
<p>8. On the <b>Triggers</b> tab click <b>New</b>. Create a <b>Daily</b> trigger and <b>Repeat task every</b> 2 minutes. Click <b>OK</b>.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_25.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_25.png" width="605" height="523"></a> 
<p>9. On the <b>Actions</b> tab click <b>New</b>. Set the following values:</p>
<p><font size="2"><b>Program/script</b>: <font face="Courier New">C:&#92;&#92;Windows&#92;&#92;System32&#92;&#92;WindowsPowerShell&#92;&#92;v1.0&#92;&#92;powershell.</font>exe<br><b>Add arguments</b>: <font face="Courier New">-File C:&#92;&#92;Scripts&#92;&#92;Sync.ps1<br></font></font><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_26.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_26.png" width="468" height="507"></a> </p>
<p>10. You should now see this as a scheduled task.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_27.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_27.png" width="626" height="66"></a> </p>
<p>11. You can wait for this to run or run it manually. It should run successfully.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_28.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_28.png" width="626" height="60"></a> 
<p><strong><u><font size="4">Deploy a Website through Web Deploy</font></u></strong></p>
<p>1. Create a new <b>ASP.NET MVC 4 Web Applications</b>. (In actually it can be anything.) Choose an <b>Internet Application</b>.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_29.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_29.png" width="501" height="65"></a> 
<p>2. Update the <b>HomeController.cs</b> code: <pre class="code"><span style="color: blue">public </span><span style="color: black">ActionResult Index()
{
    </span><span style="color: blue">string </span><span style="color: black">machineName = </span><span style="color: #2b91af">Environment</span><span style="color: black">.MachineName;
    ViewBag.Message = </span><span style="color: #a31515">"Computer Name: " </span><span style="color: black">+ machineName;

    </span><span style="color: blue">return </span><span style="color: black">View();
}</span></pre>
<p>3. Right-click on your application and click <b>Publish</b>.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_30.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_30.png" width="608" height="178"></a> 
<p>4. In the dropdown select <b>New</b>.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_31.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_31.png" width="409" height="104"></a> 
<p>5. Give your publish profile a name. Click OK.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_32.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_32.png" width="354" height="155"></a> 
<p>6. Update all the fields:<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_33.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_33.png" width="624" height="490"></a> 
<ul>
<li><b>Server</b>: This is the DNS name of the cloud service with port 8080. 
<li><b>Site name</b>: This needs to be “Default Web Site”. 
<li><b>User name</b>: This is the administrator account. 
<li><b>Password</b>: The password you set. 
<li><b>Destination URL</b>: The same as server without the ports. </li></ul>
<p>7. Click <b>Publish.</b></p>
<p>8. In Visual Studio you should see that it deployed successfully.<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_34.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_34.png" width="590" height="181"></a></p>
<blockquote>
<p><font size="2"><b>WARNING</b>: Don’t be alarmed if the browser opens and you don’t see your site. Remember that we set synchronization at two minutes and you have a 66% chance of hitting iis2 or iis3. </font></p></blockquote>
<p>9. If you go back to your RDP session with <b>iis1</b> and browse to C:&#92;&#92;inetpub&#92;&#92;wwwroot you’ll see all your content has been deployed. 
<p>10. Either way two minutes or manually invoke your synchronization task. Hit the website again and start refreshing:<br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_35.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_35.png" width="626" height="389"></a><br><a href="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_36.png"><img style="background-image: none; border-right-width: 0px; margin: 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://www.wadewegner.com/wp-content/uploads/acc7ea03346c_12181/image_thumb_36.png" width="654" height="386"></a> 
<p>That’s it!</p>
<p>Yeah, that might seem like a lot but realize that most of the work detailed here – such as the image preparation – you’ll only have to do one time. The rest of the time you’re using tools like PowerShell and Visual Studio.</p>
<p>Enjoy!</p>
