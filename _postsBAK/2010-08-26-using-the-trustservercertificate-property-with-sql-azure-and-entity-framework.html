--- 
layout: post
title: "Using the \xE2\x80\x98TrustServerCertificate\xE2\x80\x99 Property with SQL Azure and Entity Framework"
categories: 
- Entity Framework
- SQL Azure
tags: []

status: publish
type: post
published: true
meta: 
  dsq_thread_id: "609461187"
---
<p>I’ve spent the last few days refactoring a web application to leverage SQL Server via Entity Framework 4.0 (EF4) in preparation for migrating it to SQL Azure.&#160; It’s a neat application, and a great example of how to fully encapsulate your data tier (the previous version had issues due to tight coupling between the data and web tier).&#160; More on this soon.</p>  <p>So, when I deployed my database to SQL Azure (using the SQL Azure Migration Wizard) I was confounded by the following error:</p>  <div style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; padding-left: 5px; width: 600px; padding-right: 5px; font-size: 12px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px">A connection was successfully established with the server, but then an error occurred during the pre-login handshake. (provider: SSL Provider, error: 0 - The certificate's CN name does not match the passed value.)</div>  <br />  <p>I was caught off guard by this error, as I was pretty sure my connection string was valid – after all, I had copied it directly from the SQL Azure portal.&#160; Then I realized that this was the first time I had attempted to use EF4 along with SQL Azure; my first thought was, “oh crap!”</p>  <p>After a little bit of frantic research I found the following <a href="http://social.msdn.microsoft.com/Forums/en-US/ssdsgetstarted/thread/94d24825-c5f7-4fb1-8c9f-a43be3ebde70" target="_blank">question on the SQL Azure forums</a>.&#160; Raymond Li of Microsoft made the suggestion to set the ‘TrustServerCertificate’ property to True.&#160; So, I updated my connection string from …</p>  <div style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; padding-left: 5px; width: 600px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px">   <pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px"><span style="color: #0000ff">&lt;</span><span style="color: #800000">add</span> <span style="color: #ff0000">name</span>=<span style="color: #0000ff">&quot;BidNowDataContext&quot;</span></pre>

  <pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">	<span style="color: #ff0000">connectionString</span>=<span style="color: #0000ff">&quot;metadata=</pre>

  <pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">		res://*/BidNowDataContext.csdl|res://*/BidNowDataContext.ssdl|</pre>

  <pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">		res://*/BidNowDataContext.msl;</pre>

  <pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">	provider=System.Data.SqlClient;</pre>

  <pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">	provider connection string=&amp;quot;</pre>

  <pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">		Server=tcp:SERVERNAME.database.windows.net;Database=BidNow;</pre>

  <pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">		User ID=USERNAME@SERVERNAME;Password=PASSWORD;</pre>

  <pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">		Trusted_Connection=False;Encrypt=True;&amp;quot;&quot;</span></pre>

  <pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">	<span style="color: #ff0000">providerName</span>=<span style="color: #0000ff">&quot;System.Data.EntityClient&quot;</span> <span style="color: #0000ff">/&gt;</span></pre>
</div>

<p>
  <br />… to …</p>

<p></p>

<div style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; padding-left: 5px; width: 600px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px">
  <pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px"><span style="color: #0000ff">&lt;</span><span style="color: #800000">add</span> <span style="color: #ff0000">name</span>=<span style="color: #0000ff">&quot;BidNowDataContext&quot;</span></pre>

  <pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">	<span style="color: #ff0000">connectionString</span>=<span style="color: #0000ff">&quot;metadata=</pre>

  <pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">		res://*/BidNowDataContext.csdl|res://*/BidNowDataContext.ssdl|</pre>

  <pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">		res://*/BidNowDataContext.msl;</pre>

  <pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">	provider=System.Data.SqlClient;</pre>

  <pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">	provider connection string=&amp;quot;</pre>

  <pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">		Server=tcp:SERVERNAME.database.windows.net;Database=BidNow;</pre>

  <pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">		User ID=USERNAME@SERVERNAME;Password=PASSWORD;</pre>

  <pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">		Trusted_Connection=False;Encrypt=True;trustServerCertificate=true;</pre>

  <pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">		&amp;quot;&quot;</span></pre>

  <pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,&#39;Courier New&#39;,courier,monospace; font-size: 12px">	<span style="color: #ff0000">providerName</span>=<span style="color: #0000ff">&quot;System.Data.EntityClient&quot;</span> <span style="color: #0000ff">/&gt;</span></pre>
</div>

<p>
  <br />… and voilà!&#160; It worked!</p>

<p>Turns out that when <font face="Courier New">Encryt=True</font> and <font face="Courier New">TrustServerCertificate=False</font>, the driver will attempt to validate the SQL Server SSL certificate.&#160; By setting the property <font face="Courier New">TrustServerCertificate=True</font> the driver will not validate the SQL Server SSL certificate.</p>

<p>Of course, once I learned tried this I came across an article on MSDN called <a href="http://msdn.microsoft.com/en-us/library/ee336243.aspx" target="_blank">How to: Connect to SQL Azure Using ADO.NET</a> to says to set the TrustServerCertificate property to False and the Encrypt property to True to prevent any man-in-the-middle attacks, so I guess I should include the following disclaimer: <em><strong>Use at your own risk!</strong></em></p>
