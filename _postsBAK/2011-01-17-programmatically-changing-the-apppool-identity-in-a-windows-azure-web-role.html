--- 
layout: post
title: Programmatically Changing the AppPool Identity in a Windows Azure Web Role
categories: 
- AppPool
- ASP.NET
- Web Role
- Windows Azure
tags: []

status: publish
type: post
published: true
meta: 
  _edit_last: "1"
  disable_wpautop: "1"
  disable_wptexturize: "0"
  disable_convert_chars: "0"
  disable_convert_smilies: "0"
  dsq_thread_id: "609466425"
---
<p>With the Windows Azure SDK 1.3 comes full support for IIS in web roles, giving your web roles the ability to access the full range of web service features available in IIS.&#160; This provides a lot of powerful capabilities, some of which are outlined <a href="http://blogs.msdn.com/b/windowsazure/archive/2010/12/02/new-full-iis-capabilities-differences-from-hosted-web-core.aspx" target="_blank">here</a>.</p>  <p>By default, the AppPool runs as the NetworkService.&#160; Go ahead and create a new Windows Azure Project, choose a web role, and hit F5 to run it in IIS.&#160; A new AppPool is created with a GUID for the name, and you’ll see that the Identity is NetworkService.</p>  <p><a href="http://images.wadewegner.com/wordpress/2011/01/DefaultAppPoolIdentity.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="DefaultAppPoolIdentity" border="0" alt="DefaultAppPoolIdentity" src="http://images.wadewegner.com/wordpress/2011/01/DefaultAppPoolIdentity_thumb.png" width="504" height="166" /></a></p>  <p>In most cases this is fine, and the NetworkService identity is sufficient.&#160; However, there are some cases where you many need to change the AppPool identity.&#160; Here at Microsoft, for example, we have an internal proxy that manages all our network traffic.&#160; In order for traffic to move through the proxy, the underlying identity has to be an authenticated domain user.&#160; Consequently, any requests sent by the NetworkService result in errors when trying to access network resources (e.g. Windows Azure storage, AppFabric service namespaces, and SQL Azure).</p>  <p>Since we cannot proactively change the settings used to create the AppPool, we need to make the change immediately following it’s creation but before our application starts to run.&#160; Consequently, we’ll use the OnStart() method in the WebRole’s role entry point (i.e. WebRole.cs).</p>  <p>First, you’ll need to add a reference to two assemblies:</p>  <ol>   <li>System.DirectoryServices </li>    <li>Microsoft.Web.Administration (found in C:WindowsSystem32inetsrv) </li> </ol>  <p>Now, update the OnStart() method with the following code:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:abe3a165-53b6-4a5b-841b-259b362da3b3" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Code Snippet</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">public</span> <span style="color:#0000ff">override</span> <span style="color:#0000ff">bool</span> OnStart()</li> <li class="even">{</li> <li>    <span style="color:#008000">// For information on handling configuration changes</span></li> <li class="even">    <span style="color:#008000">// see the MSDN topic at http://go.microsoft.com/fwlink/?LinkId=166357.</span></li> <li>&nbsp;</li> <li class="even">    <span style="color:#0000ff">var</span> webApplicationProjectName = <span style="color:#a31515">&quot;Web&quot;</span>;</li> <li>    <span style="color:#0000ff">var</span> appPoolUser = <span style="color:#a31515">&quot;northamerica&#92;&#92;wwegner&quot;</span>;</li> <li class="even">    <span style="color:#0000ff">var</span> appPoolPass = <span style="color:#a31515">&quot;password&quot;</span>;</li> <li>    <span style="color:#0000ff">var</span> metabasePath = <span style="color:#a31515">&quot;IIS://localhost/W3SVC/AppPools&quot;</span>;</li> <li class="even">&nbsp;</li> <li>    <span style="color:#0000ff">using</span> (<span style="color:#2b91af">ServerManager</span> serverManager = <span style="color:#0000ff">new</span> <span style="color:#2b91af">ServerManager</span>())</li> <li class="even">    {</li> <li>        <span style="color:#0000ff">var</span> appPoolName = serverManager.Sites[<span style="color:#2b91af">RoleEnvironment</span>.CurrentRoleInstance.Id + <span style="color:#a31515">&quot;_&quot;</span> + webApplicationProjectName].Applications.First().ApplicationPoolName;</li> <li class="even">&nbsp;</li> <li>        <span style="color:#0000ff">using</span> (<span style="color:#2b91af">DirectoryEntry</span> appPools = <span style="color:#0000ff">new</span> <span style="color:#2b91af">DirectoryEntry</span>(metabasePath))</li> <li class="even">        {</li> <li>            <span style="color:#0000ff">using</span> (<span style="color:#2b91af">DirectoryEntry</span> devFabricAppPool = appPools.Children.Find(appPoolName, <span style="color:#a31515">&quot;IIsApplicationPool&quot;</span>))</li> <li class="even">            {</li> <li>                <span style="color:#0000ff">if</span> (devFabricAppPool != <span style="color:#0000ff">null</span>)</li> <li class="even">                {</li> <li>                    devFabricAppPool.InvokeSet(<span style="color:#a31515">&quot;AppPoolIdentityType&quot;</span>, <span style="color:#0000ff">new</span> <span style="color:#2b91af">Object</span>[] { 3 });</li> <li class="even">                    devFabricAppPool.InvokeSet(<span style="color:#a31515">&quot;WAMUserName&quot;</span>, <span style="color:#0000ff">new</span> <span style="color:#2b91af">Object</span>[] { appPoolUser });</li> <li>                    devFabricAppPool.InvokeSet(<span style="color:#a31515">&quot;WAMUserPass&quot;</span>, <span style="color:#0000ff">new</span> <span style="color:#2b91af">Object</span>[] { appPoolPass });</li> <li class="even">                    devFabricAppPool.Invoke(<span style="color:#a31515">&quot;SetInfo&quot;</span>, <span style="color:#0000ff">null</span>);</li> <li>&nbsp;</li> <li class="even">                    devFabricAppPool.CommitChanges();</li> <li>                }</li> <li class="even">            }</li> <li>        }</li> <li class="even">    }</li> <li>&nbsp;</li> <li class="even">    <span style="color:#0000ff">return</span> <span style="color:#0000ff">base</span>.OnStart();</li> <li>}</li> </ol> </div> </div> </div>  <p>&#160;</p>  <p>A few things to point out:</p>  <ul>   <li>Line #6: Specify the name of your web role project as webApplicationProjectName.&#160; This is used on line #13 to look up the newly created AppPool. </li> </ul>  <p><a href="http://images.wadewegner.com/wordpress/2011/01/image.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2011/01/image_thumb.png" width="162" height="244" /></a></p>  <ul>   <li>Lines #7 &amp; #8: Update to use your own username &amp; password. </li>    <li>Line #21: The AppPoolIdentityType of 3 means we’re providing a custom username &amp; password. </li> </ul>  <p>Once you update your code and run again, you’ll see that your AppPool is updated with the new identity.</p>  <p><a href="http://images.wadewegner.com/wordpress/2011/01/NewAppPoolIdentity.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="NewAppPoolIdentity" border="0" alt="NewAppPoolIdentity" src="http://images.wadewegner.com/wordpress/2011/01/NewAppPoolIdentity_thumb.png" width="504" height="156" /></a></p>  <p>Now, whenever your application makes a request through the network, it will originate from your domain account (or whatever you specify) instead of the NetworkService.</p>  <p><strong>WARNING</strong>: I should point out that there is one negative side effect that I’ve noticed when changing the identity of the AppPool programmatically – it will prevent the debugger from working normally.&#160; I don’t (yet) know of a way to resolve this, but I’m still looking.</p>  <p>I hope this helps!</p>
