--- 
layout: post
title: "Commerce Server Staging error: Operation must use an updateable query"
categories: 
- Commerce Server
- Tools
- Troubleshooting
tags: []

status: publish
type: post
published: true
meta: 
  _sexybookmarks_shortUrl: http://bit.ly/bJi28B
  _sexybookmarks_permaHash: 8947640548899f5cf7932d44e7a86f18
  dsq_thread_id: "609464913"
---
<p>I encountered an error today while setting up a project within the Commerce Server Staging.&nbsp; I haven't encountered it before, which leads me to believe that I must have done something abnormal on my development virtual machine.</p>
<blockquote>
<p><em><a href="http://msdn2.microsoft.com/en-us/library/ms942744.aspx">Commerce Server Staging</a> (CSS) is a service that allows you to synchronize content and data between many separate environments. Utilizing CSS, you can reliably update both Web content and business data from the source to one or more destinations.</em></p></blockquote>
<p>Using the CSS MMC, I created a simple project that stages my StarterSite content from my local directory (e.g. C:InetpubwwwrootStarterSite) to a temporary folder (e.g. C:TempDestination).&nbsp; It was meant to be the start of a proof-of-concept for a more complex network topology.&nbsp; However, I almost immediately received an error when I attempted to start replication:</p>
<p><a href="http://images.wadewegner.com/wordpress/content/binary/WindowsLiveWriter/CommerceServerStagingerrorOperationmustu_CDAE/image_1.png" atomicselection="true"><img style="BORDER-RIGHT: 0px; BORDER-TOP: 0px; BORDER-LEFT: 0px; BORDER-BOTTOM: 0px" height=118 alt="CSS: Unspecified Error" src="http://images.wadewegner.com/wordpress/content/binary/WindowsLiveWriter/CommerceServerStagingerrorOperationmustu_CDAE/image_thumb_1.png" width=190 border=0></a> </p>
<p>I just love errors like this!&nbsp; Gives me something to research and figure out ...</p>
<p>Fortunately, more valuable information was added to the application log:</p>
<blockquote>
<p><font face="Courier New" size=2>Event Type:&nbsp;&nbsp;&nbsp; Error<br />Event Source:&nbsp;&nbsp;&nbsp; Commerce Server Staging<br />Event Category:&nbsp;&nbsp;&nbsp; None<br />Event ID:&nbsp;&nbsp;&nbsp; 61208<br />Computer:&nbsp;&nbsp;&nbsp; CS2007<br />Description:<br />Error occurred with the database StagingLog.mdb.&nbsp; Error is: System.Data.OleDb.OleDbException: Operation must use an updateable query.<br />&nbsp;&nbsp; at System.Data.OleDb.OleDbCommand.ExecuteCommandTextForSingleResult(tagDBPARAMS dbParams, Object&amp; executeResult)<br />&nbsp;&nbsp; at System.Data.OleDb.OleDbCommand.ExecuteCommandText(Object&amp; executeResult)<br />&nbsp;&nbsp; at System.Data.OleDb.OleDbCommand.ExecuteCommand(CommandBehavior behavior, Object&amp; executeResult)<br />&nbsp;&nbsp; at System.Data.OleDb.OleDbCommand.ExecuteReaderInternal(CommandBehavior behavior, String method)<br />&nbsp;&nbsp; at System.Data.OleDb.OleDbCommand.ExecuteNonQuery()<br />&nbsp;&nbsp; at Microsoft.CommerceServer.Staging.Internal.ProjectDeploymentLog.ModifyLog(String projectName, String status).</font></p></blockquote>
<p>While this isn't the most explicit error, it provided enough information to track down the problem.
<p>You might be surprised to see that this error refers to an Access database.&nbsp; CSS makes use of Access database files to <a href="http://msdn2.microsoft.com/en-us/library/bb219263.aspx">store events and information</a> it audits during the staging process.&nbsp; Specifically, there are these two Access database files:
<ul>
<li>StagingLog.mdb
<ul>
<li>Found here: C:Program FilesMicrosoft Commerce Server 2007StagingData
<li>Stores internal replication information used by CSS</li></ul>
<li>events.mdb
<ul>
<li>Found here: C:Program FilesMicrosoft Commerce Server 2007StagingEvents
<li>Stores staging information that is made available to reports</li></ul></li></ul>
<p>Searching on the keywords "<a href="http://www.google.com/search?hl=en&amp;rlz=1T4GGIG_enUS227US227&amp;q=mdb+operation+must+use+an+updateable+query">mdb operation must use an updateable query</a>" led me to <a href="http://support.microsoft.com/kb/175168">KB article 175168</a>.&nbsp; This article indicated that the problem is most likely caused by a user not having the proper permissions to open the StagingLog.mdb file.</p>
<p>In comes <a href="http://www.microsoft.com/technet/sysinternals/utilities/filemon.mspx">File Monitor</a> (aka FileMon), by <a href="http://www.microsoft.com/technet/sysinternals/default.mspx">SysInternals</a>, to the rescue.&nbsp; Seriously folks, save yourself the agony and get to know the tools available from Microsoft and SysInternals.</p>
<p>I was able to capture the following "Access Denied" message via File Monitor:</p>
<p><a href="http://images.wadewegner.com/wordpress/content/binary/WindowsLiveWriter/CommerceServerStagingerrorOperationmustu_CDAE/image_3.png" atomicselection="true"><img style="BORDER-RIGHT: 0px; BORDER-TOP: 0px; BORDER-LEFT: 0px; BORDER-BOTTOM: 0px" height=17 alt=image src="http://images.wadewegner.com/wordpress/content/binary/WindowsLiveWriter/CommerceServerStagingerrorOperationmustu_CDAE/image_thumb_3.png" width=640 border=0></a> </p>
<p><strong>Solution:</strong> Turns out that the NT AUTHORITYNETWORK SERVICE has been attempting to open the StagingLog.mdb file to no avail.&nbsp; After giving the NT AUTHORITYNETWORK SERVICE the rights to Modify the StagingLog.mdb file ...</p>
<p><a href="http://images.wadewegner.com/wordpress/content/binary/WindowsLiveWriter/CommerceServerStagingerrorOperationmustu_CDAE/image_4.png" atomicselection="true"><img style="BORDER-RIGHT: 0px; BORDER-TOP: 0px; BORDER-LEFT: 0px; BORDER-BOTTOM: 0px" height=240 alt=image src="http://images.wadewegner.com/wordpress/content/binary/WindowsLiveWriter/CommerceServerStagingerrorOperationmustu_CDAE/image_thumb_4.png" width=176 border=0></a> </p>
<p>... I am now able to successfully start my CSS project and stage my StarterSite data to a separate folder.</p>
<p>UPDATE: Rather than only giving access to the StagingLog.mdb file, give the NETWORK SERVICE account access to the entire Data folder where the MDB file is located.&nbsp; Otherwise it will have issues trying to write out an LDF (Access log file)&nbsp;file when updates are made.</p>
<p>Hopefully this not only helps someone resolve this particular problem, but also shows how useful it is to equip yourself with good debugging tools!</p>
<p>Good luck!</p>
