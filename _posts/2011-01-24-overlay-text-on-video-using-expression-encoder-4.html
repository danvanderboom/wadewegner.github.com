--- 
layout: post
title: Overlay Text On Video Using Expression Encoder 4
categories: 
- Expression Encoder
tags: []

status: publish
type: post
published: true
meta: 
  _edit_last: "1"
  disable_wpautop: "1"
  disable_wptexturize: "0"
  disable_convert_chars: "0"
  disable_convert_smilies: "0"
  dsq_thread_id: "609466617"
---
<p>I recently built an application where I wanted to write some arbitrary text onto a video.&#160; I was using Expression Encoder 4 and had a difficult time finding some examples and documentation, aside from some basic MSDN documentation on <a href="http://msdn.microsoft.com/en-us/library/ff396880(v=Expression.30).aspx" target="_blank">the MediaItem class</a>.&#160; I was eventually able to figure it out, but it took a little time.&#160; Even though the end result is not particularly glamorous, I thought I’d save you some time and share what I learned.</p>  <p>The first thing to recognize is that you have to create a Bitmap of the text you want to overlay.&#160; This Bitmap is then overlayed on to the MediaItem.&#160; So, first things first, create your Bitmap.&#160; Here’s an approach:</p>  <p>   <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:a3d6ee0c-63f4-40b7-9d4c-3ef543bddfb3" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Code Snippet</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="color:#808080">///</span><span style="color:#008000"> </span><span style="color:#808080">&lt;summary&gt;</span></li> <li class="even"><span style="color:#808080">///</span><span style="color:#008000"> This method will create a bitmap based </span></li> <li><span style="color:#808080">///</span><span style="color:#008000"> </span><span style="color:#808080">&lt;/summary&gt;</span></li> <li class="even"><span style="color:#808080">///</span><span style="color:#008000"> </span><span style="color:#808080">&lt;param name=&quot;overlayText&quot;&gt;&lt;/param&gt;</span></li> <li><span style="color:#808080">///</span><span style="color:#008000"> </span><span style="color:#808080">&lt;param name=&quot;rootPath&quot;&gt;&lt;/param&gt;</span></li> <li class="even"><span style="color:#808080">///</span><span style="color:#008000"> </span><span style="color:#808080">&lt;param name=&quot;width&quot;&gt;&lt;/param&gt;</span></li> <li><span style="color:#808080">///</span><span style="color:#008000"> </span><span style="color:#808080">&lt;param name=&quot;height&quot;&gt;&lt;/param&gt;</span></li> <li class="even"><span style="color:#808080">///</span><span style="color:#008000"> </span><span style="color:#808080">&lt;returns&gt;&lt;/returns&gt;</span></li> <li><span style="color:#0000ff">private</span> <span style="color:#0000ff">static</span> <span style="color:#0000ff">string</span> createOverlayImage(<span style="color:#0000ff">string</span> overlayText, <span style="color:#0000ff">string</span> rootPath, <span style="color:#0000ff">int</span> width, <span style="color:#0000ff">int</span> height)</li> <li class="even">{</li> <li>    <span style="color:#008000">// full path for a temporary bitmap</span></li> <li class="even">    <span style="color:#0000ff">string</span> overlayFileName = rootPath + <span style="color:#a31515">&quot;&#92;&#92;&quot;</span> + <span style="color:#2b91af">Guid</span>.NewGuid().ToString() + <span style="color:#a31515">&quot;.bmp&quot;</span>;</li> <li>&nbsp;</li> <li class="even">    <span style="color:#008000">// create a bitmap</span></li> <li>    <span style="color:#2b91af">Bitmap</span> bitmap = <span style="color:#0000ff">new</span> <span style="color:#2b91af">Bitmap</span>(width, height);</li> <li class="even">    <span style="color:#2b91af">Graphics</span> g = <span style="color:#2b91af">Graphics</span>.FromImage(bitmap);</li> <li>&nbsp;</li> <li class="even">    <span style="color:#008000">// define the font</span></li> <li>    <span style="color:#2b91af">Font</span> font = <span style="color:#0000ff">new</span> <span style="color:#2b91af">Font</span>(<span style="color:#a31515">&quot;Arial&quot;</span>, (<span style="color:#0000ff">float</span>)14.0);</li> <li class="even">&nbsp;</li> <li>    <span style="color:#008000">// define the area to draw on</span></li> <li class="even">    <span style="color:#2b91af">Rectangle</span> area = <span style="color:#0000ff">new</span> <span style="color:#2b91af">Rectangle</span>(<span style="color:#0000ff">new</span> <span style="color:#2b91af">Point</span>(0, 0), <span style="color:#0000ff">new</span> <span style="color:#2b91af">Size</span>(width, height));</li> <li>&nbsp;</li> <li class="even">    <span style="color:#008000">// draw the new image</span></li> <li>    g.TextRenderingHint = System.Drawing.Text.<span style="color:#2b91af">TextRenderingHint</span>.AntiAlias;</li> <li class="even">    g.DrawString(overlayText, font, <span style="color:#2b91af">Brushes</span>.Red, area);</li> <li>&nbsp;</li> <li class="even">    <span style="color:#008000">// save the picture with the text overlay</span></li> <li>    bitmap.Save(overlayFileName);</li> <li class="even">&nbsp;</li> <li>    <span style="color:#008000">// return the path to the overlay image</span></li> <li class="even">    <span style="color:#0000ff">return</span> overlayFileName;</li> <li>}</li> </ol> </div> </div> </div> </p>  <p>Nothing too surprising here:</p>  <ul>   <li>Line #9: Pass in the text you want to overlay, the path for where you’ll store the created bitmap, and the width/height. </li>    <li>Line #12: Create a random file name for the Bitmap. </li>    <li>Line #26: You can change the font, color, and locations here if you’d like. </li> </ul>  <p>Now, with this method, you can set the overlay properties on the MediaItem like this:</p>  <p>   <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:a1613f89-7afc-412b-843d-b14e87d210e1" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Code Snippet</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="color:#008000">// sets file name to media item</span></li> <li class="even">mediaItem = <span style="color:#0000ff">new</span> <span style="color:#2b91af">MediaItem</span>(<span style="color:#a31515">&quot;test.wmv&quot;</span>);</li> <li>&nbsp;</li> <li class="even"><span style="color:#008000">// create the overlay image and return the path</span></li> <li><span style="color:#0000ff">string</span> overlayFileName = createOverlayImage(<span style="color:#a31515">&quot;Thank you for encoding this video!&quot;</span>, <span style="color:#2b91af">Environment</span>.CurrentDirectory, mediaItem.VideoSize.Width, mediaItem.VideoSize.Height);</li> <li class="even">                </li> <li><span style="color:#008000">// create the overlay on the media item</span></li> <li class="even">mediaItem.OverlayFileName = overlayFileName;</li> <li>mediaItem.OverlayLayoutMode = <span style="color:#2b91af">OverlayLayoutMode</span>.WholeSequence;</li> <li class="even">mediaItem.OverlayRect = <span style="color:#0000ff">new</span> <span style="color:#2b91af">Rectangle</span>(<span style="color:#0000ff">new</span> <span style="color:#2b91af">Point</span>(30, 10), <span style="color:#0000ff">new</span> <span style="color:#2b91af">Size</span>((mediaItem.VideoSize.Width - 30), (mediaItem.VideoSize.Height - 10)));</li> </ol> </div> </div> </div> </p>  <p>Breaking it down:</p>  <ul>   <li>Line #5: Grab the full path to the newly created Bitmap over your text overlay. </li>    <li>Line #8: Set the OverlayFileName to your Bitmap. </li>    <li>Line #9: Choose the layout mode.&#160; There are a few options here that you can explore; details are on MSDN. </li>    <li>Line #10: The OverlayRect defines where your Bitmap lives on the video.&#160; I indented it a bit, but it’s up to you. </li> </ul>  <p><a href="http://images.wadewegner.com/wordpress/2011/01/image1.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2011/01/image_thumb1.png" width="398" height="242" /></a></p>  <p>I’ve modified the Simple template provided by the Expression Encoder 4 SDK with the code.&#160; You can find it below.&#160; Hope this helps.</p>  <p><iframe style="padding-bottom: 0px; background-color: #fcfcfc; padding-left: 0px; width: 98px; padding-right: 0px; height: 115px; padding-top: 0px" title="Preview" marginheight="0" src="http://cid-952ba2b9cf071aa0.office.live.com/embedicon.aspx/.Public/OverlayTextOnVideo.zip" frameborder="0" marginwidth="0" scrolling="no"></iframe></p>
