--- 
layout: post
title: Using Web Deploy with Windows Azure for Rapid Development
categories: 
- Startup Task
- Web Deploy
- Web PI
- Windows Azure
- Windows Azure Platform
tags: []

status: publish
type: post
published: true
meta: 
  _edit_last: "1"
  disable_wpautop: "1"
  disable_wptexturize: "0"
  disable_convert_chars: "0"
  disable_convert_smilies: "0"
  dsq_thread_id: "609466277"
---
<p><em><strong>Update:</strong> Ryan Dunn has just posted </em><a href="http://dunnry.com/blog/2010/12/20/UsingWebDeployWithWindowsAzure.aspx" target="_blank"><em>Using Web Deploy with Windows Azure</em></a><em> that shows a way to use plugins to simplify the process of using Web Deploy with Windows Azure. He also provides a lot of nice commentary and context around the solution.&#160; Definitely worth reading.</em></p>  <p>While building your web application, have you ever deployed to Windows Azure and then realized you forgot to make a change?&#160; Or forgot to include an update?&#160; Or maybe you deployed and realized you made a simple mistake, and you want to quickly update it?&#160; We all have.&#160; You’ll then find yourself making the change, creating a new package, and uploading/deploying it.&#160; Then you wait.</p>  <p>Now, in the grand scheme of things, waiting 10 minutes is <u><strong>not</strong></u> a big deal – think about everything you’re getting that you don’t already have at your disposal.&#160; That said, during development and QA, it can be frustrating to have to wait while your role instance upgrades or restarts.</p>  <p>Fortunately, with the updates provided in the Windows Azure SDK 1.3, we can benefit from an existing technology called Web Deploy to make our lives <u><strong>much</strong></u> easier.</p>  <p>A few caveats first:</p>  <ol>   <li>This technique should <strong><u>only</u></strong> be used for development purposes. </li>    <li>You can only update a single role instance with this technique. </li>    <li>Since you are not updating the Windows Azure package you may lose your changes at anytime. </li> </ol>  <p>Be sure and understand the above caveats.&#160; This is <u><strong>only</strong></u> for development purposes.</p>  <p>Okay, ready to get started?&#160; Here are the steps to follow.</p>  <ol>   <li>Create a new <strong>Windows Azure Project</strong> called <strong>WindowsAzureWebDeploy</strong>.&#160; Add an ASP<strong>.NET MVC 2 Web Role</strong> called <strong>MvcWebRole</strong> to the solution.&#160; It’s up to you if you want a unit test project. </li>    <li>Created a folder called <strong>Startup</strong> in your <strong>MvcWebRole</strong> project. </li>    <li>Create three files in this folder: <strong>CreateUser.cmd</strong>, <strong>EnableWebAdmin.cmd</strong>, and <strong>InstallWebDeploy.cmd</strong>.&#160; For each of these files, change the <strong>Copy to Output Directory</strong> value to <strong>Copy always</strong> and the <strong>Build Action</strong> value to <strong>Content</strong>.</li>    <li>Within the <strong>Startup</strong> folder, create a folder called <strong>webpicmd</strong>. </li>    <li>Download <strong>WebPICmdLine</strong> <a href="http://go.microsoft.com/?linkid=9752821" target="_blank">here</a>.&#160; For more information, see the MSDN article <a href="http://msdn.microsoft.com/en-us/library/gg433092.aspx" target="_blank">Using the WebPICmd Command-Line Tool</a>. </li>    <li>Unzip the file <strong>webpicmdline_ctp.zip</strong> into the <strong>webpicmd</strong> folder. </li>    <li>In Visual Studio, add the following four files into the solution.&#160; For each of these files, change the <strong>Copy to Output Directory</strong> value to <strong>Copy always</strong>.       <ul>       <li>Microsoft.Web.Deployment.dll </li>        <li>Microsoft.Web.PlatformInstaller.dll </li>        <li>Microsoft.Web.PlatformInstaller.UI.dll </li>        <li>WebPICmdLine.exe </li>     </ul>   </li>    <li>Update <strong>CreateUser.cmd</strong> to include the following code. Be sure to change “webdeployuser” and “password” to different values:       <br />      <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:d671706a-a0b1-4a91-868e-c533a629ff21" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Code: CreateUser.cmd</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li>net user webdeployuser password /add</li> <li class="even">net localgroup administrators webdeployuser /add</li> <li>exit /b 0</li> </ol> </div> </div> </div>   </li>    <li>Update <strong>InstallWebDeploy.cmd</strong> to include the following code:       <br />      <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:1c053ae9-5cea-4f05-b6f0-1d7e7144ef01" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Code: InstallWebDeploy.cmd</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li>&quot;%~dp0&#92;webpicmd&#92;WebPICmdLine.exe&quot; /Products: WDeploy /xml:https://www.microsoft.com/web/webpi/2.0/RTM/WebProductList.xml /log:webdeploy.txt</li> <li class="even">net stop wmsvc</li> <li>net start wmsvc</li> </ol> </div> </div> </div>   </li>    <li>Update <strong>EnableWebAdmin.cmd</strong> to include the following code:       <br />      <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:925c61c4-6fca-4242-b3d7-cc8a9be3f732" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Code: EnableWebAdmin.cmd</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li>start /w ocsetup IIS-ManagementService</li> <li class="even">reg add HKEY_LOCAL_MACHINE&#92;SOFTWARE&#92;Microsoft&#92;WebManagement&#92;Server /v EnableRemoteManagement /t REG_DWORD /d 1 /f</li> <li>net start wmsvc</li> <li class="even">sc config WMSVC start= auto</li> <li>exit /b 0</li> </ol> </div> </div> </div>   </li>    <li>Open the <strong>ServiceDefinition.csdef</strong> file in the <strong>WindowsAzureWebDeploy</strong> project. </li>    <li>Add a new <strong>InputEndpoint</strong> named <strong>mgmtsvc</strong> with the following values:       <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:1b902c59-dff3-454a-be9b-73c4de4fd430" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Code: InputEndpoint</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">&lt;</span><span style="color:#a31515">Endpoints</span><span style="color:#0000ff">&gt;</span></li> <li class="even">  <span style="color:#0000ff">&lt;</span><span style="color:#a31515">InputEndpoint</span><span style="color:#0000ff"> </span><span style="color:#ff0000">name</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">Endpoint1</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">protocol</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">http</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">port</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">80</span>&quot;<span style="color:#0000ff"> /&gt;</span></li> <li>  <span style="color:#0000ff">&lt;</span><span style="color:#a31515">InputEndpoint</span><span style="color:#0000ff"> </span><span style="color:#ff0000">name</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">mgmtsvc</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">protocol</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">tcp</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">port</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">8172</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">localPort</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">8172</span>&quot;<span style="color:#0000ff"> /&gt;</span></li> <li class="even"><span style="color:#0000ff">&lt;/</span><span style="color:#a31515">Endpoints</span><span style="color:#0000ff">&gt;</span></li> </ol> </div> </div> </div>   </li>    <li>Create three <strong>Startup Tasks</strong> to call the command files in the <strong>MvcWebRole</strong>.       <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:762a9b83-a435-4dbe-8af4-50836b38da62" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Code: Startup Tasks</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">&lt;</span><span style="color:#a31515">Startup</span><span style="color:#0000ff">&gt;</span></li> <li class="even">  <span style="color:#0000ff">&lt;</span><span style="color:#a31515">Task</span><span style="color:#0000ff"> </span><span style="color:#ff0000">commandLine</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">Startup&#92;EnableWebAdmin.cmd</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">executionContext</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">elevated</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">taskType</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">simple</span>&quot;<span style="color:#0000ff"> /&gt;</span></li> <li>  <span style="color:#0000ff">&lt;</span><span style="color:#a31515">Task</span><span style="color:#0000ff"> </span><span style="color:#ff0000">commandLine</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">Startup&#92;InstallWebDeploy.cmd</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">executionContext</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">elevated</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">taskType</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">simple</span>&quot;<span style="color:#0000ff"> /&gt;</span></li> <li class="even">  <span style="color:#0000ff">&lt;</span><span style="color:#a31515">Task</span><span style="color:#0000ff"> </span><span style="color:#ff0000">commandLine</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">Startup&#92;CreateUser.cmd</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">executionContext</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">elevated</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">taskType</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">simple</span>&quot;<span style="color:#0000ff"> /&gt;</span></li> <li><span style="color:#0000ff">&lt;/</span><span style="color:#a31515">Startup</span><span style="color:#0000ff">&gt;</span></li> </ol> </div> </div> </div>   </li>    <li>That’s it! </li> </ol>  <p><em><strong>Update (12/21/2010):</strong> I have made a few updates above to the scripts based on feedback and testing.</em></p>  <p>At this point, you are ready to deploy your application.&#160; When the role instance starts-up, the three start-up tasks will run and 1) create an user, 2) install web deploy through the Web Platform installer, and 3) enable web administration.&#160; This process can take several minutes to complete.</p>  <p>Once deployed, your application should look like this:</p>  <p><a href="http://images.wadewegner.com/wordpress/2010/12/image10.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Pre-Web Deploy" border="0" alt="Pre-Web Deploy" src="http://images.wadewegner.com/wordpress/2010/12/image_thumb.png" width="504" height="313" /></a></p>  <p>Now it’s time to setup your <strong>MvcWebRole</strong> project to publish directly to your role instance through web deploy.&#160; First, though, make a quick change to your application so that, after you deploy, you can verify that the new bits are deployed.</p>  <p>Update <strong>Views –&gt; Home –&gt; Index.aspx</strong> and replace the existing header with:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:a09af5db-9d47-4819-bcaf-b8ecd1bba1a7" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Code: Updated Index.aspx</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">&lt;</span><span style="color:#800000">h2</span><span style="color:#0000ff">&gt;</span>Deployed with Web Deploy<span style="color:#0000ff">&lt;/</span><span style="color:#800000">h2</span><span style="color:#0000ff">&gt;</span></li> </ol> </div> </div> </div>  <p>   <br />Now, let’s publish the update.</p>  <ol>   <li>Right-click <strong>MvcWebRole</strong> and click <strong>Publish…</strong>. </li>    <li>Create a profile name (e.g. <strong>MvcWebRole</strong>). </li>    <li>Add your full DNS name as the <strong>Service URL</strong> (e.g. <strong>mywebdeploy.cloudapp.net</strong>). </li>    <li>Add the <strong>Site/application</strong> value.&#160; This is essentially <em><strong>yourrolename</strong></em>_IN_0_Web (e.g. <strong>MvcWebRole_IN_0_Web</strong>).&#160; Don’t forget the “_Web” at the end. </li>    <li>Check the <strong>Mark the IIS application on destination</strong> checkbox. </li>    <li>Remove the check from the <strong>Leave extra files on the destination (do not delete)</strong> checkbox. </li>    <li>Check the <strong>Allow untrusted certificate</strong> checkbox. </li>    <li>Add your <strong>User name</strong> (e.g. “webdeployuser”). </li>    <li>Add your <strong>Password</strong>. </li>    <li>Check the <strong>Save password</strong> checkbox. </li>    <li>Click <strong>Publish</strong>. </li> </ol>  <p>Once complete, your <strong>Publish Web</strong> window should look something like this:</p>  <p><a href="http://images.wadewegner.com/wordpress/2010/12/image11.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2010/12/image_thumb1.png" width="361" height="484" /></a></p>  <p>After you get the message <strong>Publish succeeded</strong>, refresh your page.&#160; It should now look like this:</p>  <p><a href="http://images.wadewegner.com/wordpress/2010/12/DeployedWithWebDeploy.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="DeployedWithWebDeploy" border="0" alt="DeployedWithWebDeploy" src="http://images.wadewegner.com/wordpress/2010/12/DeployedWithWebDeploy_thumb.png" width="504" height="312" /></a></p>  <p>And there you have it!&#160; Within seconds you’ve deployed updates to your application running in Windows Azure.</p>  <p>Now, do you remember the caveats above?&#160; If nothing else, remember that this is <u><strong>only</strong></u> for development purposes.&#160; I don’t want to hear that you used this in production then lost all your changes when a role instance was restarted.</p>  <p>I hope this helps!</p>
