--- 
layout: post
title: Using the SAML CredentialType to Authenticate to the Service Bus
categories: 
- Access Control
- SAML
- Service Bus
- Windows Azure
- Windows Azure AppFabric
tags: []

status: publish
type: post
published: true
meta: 
  _edit_last: "1"
  disable_wpautop: "1"
  disable_wptexturize: "0"
  disable_convert_chars: "0"
  disable_convert_smilies: "0"
  _wp_old_slug: using-a-saml-token-for-the-service-bus-transport-client-credential
  dsq_thread_id: "609465862"
---
<p>The <a href="http://msdn.microsoft.com/en-us/library/ee732537.aspx" target="_blank">Windows Azure AppFabric Service Bus</a> uses a class called <font size="2" face="Courier New"><a href="http://msdn.microsoft.com/en-us/library/microsoft.servicebus.transportclientendpointbehavior.aspx" target="_blank">TransportClientEndpointBehavior</a></font> to specify the credentials for a particular endpoint.&#160; There are four options available to you: Unauthenticated, SimpleWebToken, SharedSecret, and SAML.&#160; For details, take a look at the <font size="2" face="Courier New"><a href="http://msdn.microsoft.com/en-us/library/dd582752.aspx" target="_blank">CredentialType</a></font> member.&#160; The first three are pretty well described and documented – in fact, if you’ve spent any time at all looking at the Service Bus, you’ve probably seen the following code:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:576fd129-914e-414c-87fa-3c0cb167fcd4" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">SharedSecret Credential Type</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="color:#2b91af">TransportClientEndpointBehavior</span> relayCredentials = <span style="color:#0000ff">new</span> <span style="color:#2b91af">TransportClientEndpointBehavior</span>();</li> <li class="even">relayCredentials.CredentialType = <span style="color:#2b91af">TransportClientCredentialType</span>.SharedSecret;</li> <li>relayCredentials.Credentials.SharedSecret.IssuerName = issuerName;</li> <li class="even">relayCredentials.Credentials.SharedSecret.IssuerSecret = issuerSecret;</li> </ol> </div> </div> </div>  <p>   <br />This code specifies that the client credential is provided as a self-issued shared secret that is registered and managed by <a href="http://msdn.microsoft.com/en-us/library/ee732536.aspx" target="_blank">Access Control</a>, along with the Issuer Name and Issuer Secret that you can grab (or generate) in the AppFabric portal. Quick and easy, but only marginally better than a username/password.</p>  <p>The use of a SAML token is more interesting, and in fact lately I’ve seen a number of requests for a sample.&#160; Unfortunately, it doesn’t appear that anyone has ever created a sample on how this should work.&#160; It’s one thing to say that the above code would change to the following …</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:a43a0598-8dc1-4b48-8272-bb5e83c3a27d" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Saml Credential Type</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="color:#2b91af">TransportClientEndpointBehavior</span> samlCredentials = <span style="color:#0000ff">new</span> <span style="color:#2b91af">TransportClientEndpointBehavior</span>();</li> <li class="even">samlCredentials.CredentialType = <span style="color:#2b91af">TransportClientCredentialType</span>.Saml;</li> </ol> </div> </div> </div>  <br />  <br />  <p>… and something else to provide a sample that works.&#160; What makes this challenging is the creation of the SAML token – this is a complex process, and difficult to setup, test, or fake.&#160; Fortunately for you, I have put together a sample on how to use a SAML token as the <font size="2" face="Courier New">CredentialType</font> of the <font size="2" face="Courier New">TransportClientEndpointBehavior</font>.</p>  <p><strong>DISCLAIMER</strong>: I am not an identity expert.&#160; You should look to people like <a href="http://blogs.msdn.com/b/justinjsmith/" target="_blank">Justin Smith</a>, <a href="http://blogs.msdn.com/b/vbertocci/" target="_blank">Vittorio Bertocci</a>, <a href="http://www.dynamic-cast.com/" target="_blank">Hervey Wilson</a>, and <a href="http://blogs.msdn.com/b/sskier/" target="_blank">Maciej (&quot;Ski&quot;) Skierkowski's</a> for specific identity guidance.&#160; I’m simply leveraging much of the material, samples, and code they’ve written in order to enable this particular scenario.</p>  <p>In order to get this sample to work I’ve a number of frameworks.&#160; You’ll need to download and install these to get everything to work properly.</p>  <ul>   <li><a href="http://www.microsoft.com/net/" target="_blank">.NET 4.0 Framework</a> – I’ve only tested this with Visual Studio 2010 and the .NET 4.0 Framework. </li>    <li><a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=39856a03-1490-4283-908f-c8bf0bfad8a5&amp;displaylang=en" target="_blank">Windows Azure AppFabric SDK V1.0</a> – this SDK provides you with all the assemblies you’ll need in order to use the Service Bus. </li>    <li><a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=eb9c345f-e830-40b8-a5fe-ae7a864c4d76&amp;displaylang=en" target="_blank">Windows Identity Foundation</a> – WIF allows you to externalize use access from applications via claims (which is what we want to do). </li>    <li><a href="http://www.microsoft.com/downloads/en/details.aspx?familyid=C148B2DF-C7AF-46BB-9162-2C9422208504&amp;displaylang=en" target="_blank">Windows Identity Foundation SDK</a> – the WIF SDK provides you with templates and code samples to get going.&#160; Technically I don’t think we’re using this, but I have it installed and I’m not going to uninstall it to test. </li> </ul>  <p>I also used a number of samples in order to build this sample.&#160; You won’t need to download and install these in order to use this sample – I’m providing the source of the modified code below – but you might want to take a look at them anyways.</p>  <ul>   <li><a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=39856a03-1490-4283-908f-c8bf0bfad8a5&amp;displaylang=en" target="_blank">Windows Azure AppFabric SDK Samples (C#)</a> – specifically, I used the Service Bus <strong>EchoSample</strong> solution and Access Control <strong>AcmBrowser </strong>application. </li>    <li><a href="http://code.msdn.microsoft.com/fshipsaassource" target="_blank">Fabrikam Shipping SaaS Demo</a> – this is a great sample application, and I suggest you take a look. I personally used the SelfSTS and TestClient solutions – more on this in a moment. </li> </ul>  <p>Okay, now that we’ve got the various components and samples described, let’s get to the sample.</p>  <p><strong><u>Overview</u></strong></p>  <p>When I first started writing this post, I thought it’d be short and sweet.&#160; As you can see, it’s anything but.&#160; However, when you look through everything, I think you’ll see that there’s quite a bit to this sample.</p>  <p>There are three major pieces in this sample:</p>  <ol>   <li>Using a security token service (STS) to generate a SAML token. </li>    <li>Configuring the Access Control service to accept the SAML token and authorize our WCF service to Send or Listen across the Service Bus. </li>    <li>Modifying the EchoSample WCF service to get a SAML token and send it to Access Control. </li> </ol>  <p>Let’s walk through the pieces.</p>  <p><strong><u>The Security Token Service</u></strong></p>  <p>Remember my disclaimer above?&#160; Since I’m not an identity guy, I decided to use a tool built by an identity guy to act as my STS.&#160; <a href="http://blogs.msdn.com/b/vbertocci/archive/2010/08/23/selfsts-when-you-need-a-saml-token-now-right-now.aspx" target="_blank">Vittorio</a> has created a fabulous tool called <a href="http://code.msdn.microsoft.com/SelfSTS" target="_blank">SelfSTS</a>, which exposes a minimal WS-Federation STS endpoint.&#160; In the <a href="http://code.msdn.microsoft.com/fshipsaassource" target="_blank">Fabrikam Shipping SaaS Demo Source Code</a>, he provided an updated version of the SelfSTS tool that will also issue via WS-Trust, along with a sample on how to acquire the token and send it to ACS.</p>  <p>If you download FabrikamShippingSaaS and install it in the default location, you can find these two assets in the following locations:</p>  <ul>   <li>Updated SelfSTS: <font size="2" face="Courier New">C:FabrikamShippingSaaSassetsSelfSTSSelfSTS.sln</font> </li>    <li>Token acquisition and ACS submittal example: <font size="2" face="Courier New">C:FabrikamShippingSaaScodeTestClient.sln</font> </li> </ul>  <p>Definitely take a look at these resources.&#160; I highly encourage you to use these as much and as often as you like – the SelfSTS tool is invaluable when working with Access Control and WIF.&#160; In the TestClient solution, the method we’re most interested in is the <font size="2" face="Courier New">GetSAMLToken</font> method found in the Program.cs file.&#160; Take a look at it, but realize that we’re going to make a few changes to it for our example.</p>  <p>For the purposes of this sample, I took the SelfSTS project and included it in the EchoSampleSAML solution that you can find below.&#160; The only update I made to the tool was to extract a method I called <font size="2" face="Courier New">Start</font> – which encapsulates all of the logic needed to start the tool – and call it in the <font size="2" face="Courier New">Main </font>method.</p>  <p>Go ahead and run the SelfSTS project in the EchoSampleSAML solution below by right-clicking and choosing Debug –&gt; Start New Instance.&#160; It looks like this:</p>  <p><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="SelfSTS" border="0" alt="SelfSTS" src="http://images.wadewegner.com/wordpress/2010/11/image1.png" width="249" height="331" /></p>  <p>There are two items that we’ll leverage below:</p>  <ul>   <li>The Endpoint: <a title="http://localhost:8000/STS/Issue/" href="http://localhost:8000/STS/Issue/">http://localhost:8000/STS/Issue/</a> </li>    <li>The “Metadata” URL: <a title="http://localhost:8000/STS/FederationMetadata/2007-06/FederationMetadata.xml" href="http://localhost:8000/STS/FederationMetadata/2007-06/FederationMetadata.xml">http://localhost:8000/STS/FederationMetadata/2007-06/FederationMetadata.xml</a> </li> </ul>  <p>Quickly stop the SelfSTS and click “Edit Claim Types and Values”.</p>  <p><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Edit Claims" border="0" alt="Edit Claims" src="http://images.wadewegner.com/wordpress/2010/11/EditClaims.png" width="500" height="304" /></p>  <p>These are the claims that the SelfSTS will return.&#160; I’ve highlighted “joe” because we’re going to use this claim below when configuring Access Control.&#160; Make a mental note, because I want you to be aware of where “joe” comes from.</p>  <p>Go ahead and keep this tool running the entire time – you’ll leverage it throughout this process.</p>  <p><strong><u>Configuring Access Control</u></strong></p>  <p>The production Access Control services does not provide a UI in the portal to configure issuers and rules.&#160; Consequently, we’ll use the AcmBrowser tool found within the Windows Azure AppFabric SDK Samples.&#160; Depending on where you unzip the samples, you’ll find it here:</p>  <ol>   <p>C:WindowsAzureAppFabricSDKSamples_V1.0-CSAccessControlExploringFeaturesManagementAcmBrowser</p> </ol>  <p>When you open the solution you’ll have to upgrade it for Visual Studio 2010.&#160; Start the application.&#160; You’ll see something like the following:</p>  <p><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="AcmBrowser" border="0" alt="AcmBrowser" src="http://images.wadewegner.com/wordpress/2010/11/AcmBrowser.png" width="500" height="378" /></p>  <p>This is a very handy tool, but unfortunately it takes a little time to get used to it.&#160; The very first thing to do is enter your Service Namespace and Management Key (see A above).&#160; You can get these off of the AppFabric portal (i.e. <a href="http://appfabric.azure.com">http://appfabric.azure.com</a>) in the following places:</p>  <p><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Service Namespace and Management Key" border="0" alt="Service Namespace and Management Key" src="http://images.wadewegner.com/wordpress/2010/11/ServiceNamespace.png" width="502" height="175" /></p>  <p><strong>Note:</strong> Make sure to put a “-sb” at the end of your Service Namespace in the AcmBrowser tool.&#160; This is because the tool calls the Access Control Management Endpoint, which by convention is your service namespace with a “-sb” appended to it.</p>  <p>Once you’ve entered these values, click the “Load from Cloud” button (see B above).&#160; This will grab your existing settings and load them into the Resources list.&#160; I recommend you click the “Save” button (see C above) to save a copy of them locally – this way you’ll have something to revert to if you make a mistake.</p>  <p>Okay, now that you have the basics loaded into AcmBrowser, here are the steps to setup Access Control:</p>  <ol>   <li>Right-click “Issuers” and click “Create”.&#160; Enter the following values and press OK.      <ul>       <li>Display Name: SelfSTS </li>        <li>Algorithm: FedMetadata </li>        <li>Endpoint URI: <a title="http://localhost:8000/STS/FederationMetadata/2007-06/FederationMetadata.xml" href="http://localhost:8000/STS/FederationMetadata/2007-06/FederationMetadata.xml">http://localhost:8000/STS/FederationMetadata/2007-06/FederationMetadata.xml</a> (from the SelfSTS)           <br />          <br /><a href="http://images.wadewegner.com/wordpress/2010/11/image2.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2010/11/image_thumb.png" width="240" height="169" /></a>           <br /></li>     </ul>   </li>    <li>Expand Scopes –&gt; ServiceBus Scope for … –&gt; Rules. </li>    <li>Create a rule that will allow “joe” to Send messages to the Service Bus endpoint (remember “joe” from above?).&#160; Right-click “Rules” and click “Create”.&#160; Enter the following values and press OK.      <ul>       <li>Display Name: test send </li>        <li>Type: Simple </li>        <li>Input Claim          <ul>           <li>Issuer: SelfSTS </li>            <li>Type: <a title="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name" href="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name">http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name</a> </li>            <li>Value: joe </li>         </ul>       </li>        <li>Output Claim          <ul>           <li>Type: net.windows.servicebus.action </li>            <li>Value: Send              <br />              <br /><a href="http://images.wadewegner.com/wordpress/2010/11/image3.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="test send" border="0" alt="test send" src="http://images.wadewegner.com/wordpress/2010/11/image_thumb1.png" width="240" height="235" /></a>               <br /></li>         </ul>       </li>     </ul>   </li>    <li>Create a rule that will allow “joe” to Send messages to the Service Bus endpoint (remember “joe” from above?).&#160; Right-click “Rules” and click “Create”.&#160; Enter the following values and press OK.      <ul>       <li>Display Name: test listen </li>        <li>Type: Simple </li>        <li>Input Claim          <ul>           <li>Issuer: SelfSTS </li>            <li>Type: <a title="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name" href="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name">http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name</a> </li>            <li>Value: joe </li>         </ul>       </li>        <li>Output Claim          <ul>           <li>Type: net.windows.servicebus.action </li>            <li>Value: Listen              <br />              <br /><a href="http://images.wadewegner.com/wordpress/2010/11/image4.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="test listen" border="0" alt="test listen" src="http://images.wadewegner.com/wordpress/2010/11/image_thumb2.png" width="240" height="235" /></a>               <br /></li>         </ul>       </li>     </ul>   </li>    <li>Now you need to update Access Control.&#160; Unfortunately, AcmBrowser doesn’t update Access Control, so you have to clear then save.      <ul>       <li>Click the “Clear Service Namespace in Cloud” button (see D above). </li>        <li>Click the “Save to Cloud” button (see E above). </li>     </ul>   </li> </ol>  <p>That’s it for Access Control.&#160; We’ve setup the SelfSTS as a trusted Issuer, and we’ve defined two rules – Send and Listen – for the claim “name” with a value of “joe”.</p>  <p><strong><u>Modifying the EchoSample to Use </u></strong></p>  <p>The rest of this sample is really pretty straightforward – we’ve either already done most of the work, or we’ll leverage a few code snippets from different resources.&#160; The first thing we’ll do is add a GetSAMLToken method to the Service project in the EchoSample.&#160; Add the following method in the Program.cs file:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:6e7ddc18-4dd4-4499-b51d-623fcfd14258" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Getting the SAML Token</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">private</span> <span style="color:#0000ff">static</span> <span style="color:#0000ff">string</span> GetSAMLToken(<span style="color:#0000ff">string</span> identityProviderUrl, <span style="color:#0000ff">string</span> identityProviderCertificateSubjectName, <span style="color:#0000ff">string</span> username, <span style="color:#0000ff">string</span> password, <span style="color:#0000ff">string</span> appliesTo)</li> <li class="even">{</li> <li>    <span style="color:#2b91af">GenericXmlSecurityToken</span> token = <span style="color:#0000ff">null</span>;</li> <li class="even">&nbsp;</li> <li>    <span style="color:#0000ff">var</span> binding = <span style="color:#0000ff">new</span> <span style="color:#2b91af">WS2007HttpBinding</span>();</li> <li class="even">&nbsp;</li> <li>    binding.Security.Mode = <span style="color:#2b91af">SecurityMode</span>.Message;</li> <li class="even">    binding.Security.Message.ClientCredentialType = <span style="color:#2b91af">MessageCredentialType</span>.UserName;</li> <li>    binding.Security.Message.EstablishSecurityContext = <span style="color:#0000ff">false</span>;</li> <li class="even">    binding.Security.Message.NegotiateServiceCredential = <span style="color:#0000ff">true</span>;</li> <li>&nbsp;</li> <li class="even">    <span style="color:#0000ff">using</span> (<span style="color:#0000ff">var</span> trustChannelFactory = <span style="color:#0000ff">new</span> <span style="color:#2b91af">WSTrustChannelFactory</span>(binding, <span style="color:#0000ff">new</span> <span style="color:#2b91af">EndpointAddress</span>(<span style="color:#0000ff">new</span> <span style="color:#2b91af">Uri</span>(identityProviderUrl), <span style="color:#0000ff">new</span> <span style="color:#2b91af">DnsEndpointIdentity</span>(identityProviderCertificateSubjectName), <span style="color:#0000ff">new</span> <span style="color:#2b91af">AddressHeaderCollection</span>())))</li> <li>    {</li> <li class="even">        trustChannelFactory.Credentials.UserName.UserName = username;</li> <li>        trustChannelFactory.Credentials.UserName.Password = password;</li> <li class="even">        trustChannelFactory.Credentials.ServiceCertificate.Authentication.CertificateValidationMode = <span style="color:#2b91af">X509CertificateValidationMode</span>.None;</li> <li>&nbsp;</li> <li class="even">        trustChannelFactory.TrustVersion = <span style="color:#2b91af">TrustVersion</span>.WSTrust13;</li> <li>&nbsp;</li> <li class="even">        <span style="color:#2b91af">WSTrustChannel</span> channel = <span style="color:#0000ff">null</span>;</li> <li>&nbsp;</li> <li class="even">        <span style="color:#0000ff">try</span></li> <li>        {</li> <li class="even">            <span style="color:#0000ff">var</span> rst = <span style="color:#0000ff">new</span> <span style="color:#2b91af">RequestSecurityToken</span>(<span style="color:#2b91af">WSTrust13Constants</span>.<span style="color:#2b91af">RequestTypes</span>.Issue);</li> <li>            rst.AppliesTo = <span style="color:#0000ff">new</span> <span style="color:#2b91af">EndpointAddress</span>(appliesTo);</li> <li class="even">            rst.KeyType = <span style="color:#2b91af">KeyTypes</span>.Bearer;</li> <li>&nbsp;</li> <li class="even">            channel = (<span style="color:#2b91af">WSTrustChannel</span>)trustChannelFactory.CreateChannel();</li> <li>            token = channel.Issue(rst) <span style="color:#0000ff">as</span> <span style="color:#2b91af">GenericXmlSecurityToken</span>;</li> <li class="even">            ((<span style="color:#2b91af">IChannel</span>)channel).Close();</li> <li>            channel = <span style="color:#0000ff">null</span>;</li> <li class="even">&nbsp;</li> <li>            trustChannelFactory.Close();</li> <li class="even">&nbsp;</li> <li>            <span style="color:#0000ff">string</span> tokenString = token.TokenXml.OuterXml;</li> <li class="even">            <span style="color:#0000ff">return</span> tokenString;</li> <li>        }</li> <li class="even">        <span style="color:#0000ff">finally</span></li> <li>        {</li> <li class="even">            <span style="color:#0000ff">if</span> (channel != <span style="color:#0000ff">null</span>)</li> <li>            {</li> <li class="even">                ((<span style="color:#2b91af">IChannel</span>)channel).Abort();</li> <li>            }</li> <li class="even">&nbsp;</li> <li>            <span style="color:#0000ff">if</span> (trustChannelFactory != <span style="color:#0000ff">null</span>)</li> <li class="even">            {</li> <li>                trustChannelFactory.Abort();</li> <li class="even">            }</li> <li>        }</li> <li class="even">    }</li> <li>}</li> </ol> </div> </div> </div>  <p>   <br />This method is almost identical to the GetSAMLToken found in FabrikamShippingSaaS’s TestClient.&#160; Here are the changes I made:</p>  <ul>   <li>Line 1: I changed the return type from <font size="2" face="Courier New">SecurityToken</font> to <font size="2" face="Courier New">string</font>.&#160; This is because the <font size="2" face="Courier New">TransportClientEndpointBehavior</font> will want the SAML token as a string. </li>    <li>Lines 5-10: I moved the code from the GetSecurityTokenServiceBinding method into the GetSamleToken method.&#160; This is simply for readability in this blog post. </li>    <li>Line 32: I removed the following code: <font size="2" face="Courier New">rst.Entropy = new Entropy(CreateEntropy());</font> </li>    <li>Line 35: Added this line to grab the token out of the <font size="2" face="Courier New">GenericXmlSecurityToken</font> object. </li>    <li>Line 36: Returning the <font size="2" face="Courier New">tokenString</font> instead of the <font size="2" face="Courier New">token</font>.       <ul></ul>   </li> </ul>  <p>Now, there are a few values that we’re going to start in the App.config file.&#160; Here they are:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:2d3498f6-4b9b-43ba-bec1-d939cea494e2" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">App.Config file</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">&lt;</span><span style="color:#a31515">appSettings</span><span style="color:#0000ff">&gt;</span></li> <li class="even">  <span style="color:#0000ff">&lt;</span><span style="color:#a31515">add</span><span style="color:#0000ff"> </span><span style="color:#ff0000">key</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">identityProviderCertificateSubjectName</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">value</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">adventureWorks</span>&quot;<span style="color:#0000ff"> /&gt;</span></li> <li>  <span style="color:#0000ff">&lt;</span><span style="color:#a31515">add</span><span style="color:#0000ff"> </span><span style="color:#ff0000">key</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">identityProviderUrl</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">value</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">http://localhost:8000/STS/Username</span>&quot;<span style="color:#0000ff"> /&gt;</span></li> <li class="even">  <span style="color:#0000ff">&lt;</span><span style="color:#a31515">add</span><span style="color:#0000ff"> </span><span style="color:#ff0000">key</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">appliesTo</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">value</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">https://{0}-sb.accesscontrol.windows.net/WRAPv0.9</span>&quot;<span style="color:#0000ff"> /&gt;</span></li> <li>  <span style="color:#0000ff">&lt;</span><span style="color:#a31515">add</span><span style="color:#0000ff"> </span><span style="color:#ff0000">key</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">serviceNamespace</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">value</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">YOURSERVICENAMESPACE</span>&quot;<span style="color:#0000ff"> /&gt;</span></li> <li class="even">&nbsp;</li> <li>  <span style="color:#0000ff">&lt;!--</span><span style="color:#008000"> this is the user and pwd of the user in AdventureWorks IdP </span><span style="color:#0000ff">--&gt;</span></li> <li class="even">  <span style="color:#0000ff">&lt;</span><span style="color:#a31515">add</span><span style="color:#0000ff"> </span><span style="color:#ff0000">key</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">username</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">value</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">joe</span>&quot;<span style="color:#0000ff"> /&gt;</span></li> <li>  <span style="color:#0000ff">&lt;</span><span style="color:#a31515">add</span><span style="color:#0000ff"> </span><span style="color:#ff0000">key</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">password</span>&quot;<span style="color:#0000ff"> </span><span style="color:#ff0000">value</span><span style="color:#0000ff">=</span>&quot;<span style="color:#0000ff">p@ssw0rd</span>&quot;<span style="color:#0000ff"> /&gt;</span></li> <li class="even"><span style="color:#0000ff">&lt;/</span><span style="color:#a31515">appSettings</span><span style="color:#0000ff">&gt;</span></li> </ol> </div> </div> </div>  <p>   <br />Replace <strong>YOURSERVICENAMESPACE</strong> with your actual service namespace.</p>  <p>Now, let’s create some static variables for these values in the Program.cs file:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:a306b3b0-3e04-4f7f-93a0-f0ccd9b6bc73" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Static Variables</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">static</span> <span style="color:#0000ff">string</span> identityProviderUrl = <span style="color:#2b91af">ConfigurationManager</span>.AppSettings[<span style="color:#a31515">&quot;identityProviderUrl&quot;</span>];</li> <li class="even"><span style="color:#0000ff">static</span> <span style="color:#0000ff">string</span> identityProviderCertificateSubjectName = <span style="color:#2b91af">ConfigurationManager</span>.AppSettings[<span style="color:#a31515">&quot;identityProviderCertificateSubjectName&quot;</span>];</li> <li><span style="color:#0000ff">static</span> <span style="color:#0000ff">string</span> username = <span style="color:#2b91af">ConfigurationManager</span>.AppSettings[<span style="color:#a31515">&quot;username&quot;</span>];</li> <li class="even"><span style="color:#0000ff">static</span> <span style="color:#0000ff">string</span> password = <span style="color:#2b91af">ConfigurationManager</span>.AppSettings[<span style="color:#a31515">&quot;password&quot;</span>];</li> <li><span style="color:#0000ff">static</span> <span style="color:#0000ff">string</span> serviceNamespace = <span style="color:#2b91af">ConfigurationManager</span>.AppSettings[<span style="color:#a31515">&quot;serviceNamespace&quot;</span>];</li> <li class="even"><span style="color:#0000ff">static</span> <span style="color:#0000ff">string</span> appliesTo = <span style="color:#2b91af">String</span>.Format(<span style="color:#2b91af">ConfigurationManager</span>.AppSettings[<span style="color:#a31515">&quot;appliesTo&quot;</span>], serviceNamespace);</li> </ol> </div> </div> </div>  <p>   <br />Now, we’re going to change a number of things within the Main method.&#160; First, remove the Console.Write() and Console.ReadLine() sections – we’re grabbing those out of the App.Config file.&#160; Next, we need to grab the SAML token.&#160; Write the following line:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:9024f1a4-59fc-42fa-8680-90faeb9018ea" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Code Snippet</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">string</span> samlToken = GetSAMLToken(identityProviderUrl, identityProviderCertificateSubjectName, username, password, appliesTo);</li> </ol> </div> </div> </div>  <p>   <br />This will call the GetSAMLToken method and pass along all the values required in order to generate the SAML token.&#160; When this runs, it will call out to SelfSTS and pass along the username/password specified in the App.Config file and, in return, get a SAML token that includes all the claims we want – including the “name”.</p>  <p>Now, we have to take this SAML token as use it with the <font size="2" face="Courier New">TransportClientEndpointBehavior</font>.&#160; Remove the existing <font size="2" face="Courier New">TransportClientEndpointBehavior</font>, and replace it with the following code:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:f7563c8e-a4c4-4d9d-824d-d25d396bf57a" class="wlWriterEditableSmartContent"> <div class="le-pavsc-container"> <div class="le-pavsc-titleblock">Code Snippet</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="color:#2b91af">TransportClientEndpointBehavior</span> samlCredentials = <span style="color:#0000ff">new</span> <span style="color:#2b91af">TransportClientEndpointBehavior</span>();</li> <li class="even">samlCredentials.CredentialType = <span style="color:#2b91af">TransportClientCredentialType</span>.Saml;</li> <li>samlCredentials.Credentials.Saml.SamlToken = samlToken;</li> </ol> </div> </div> </div>  <p>   <br />We’re now creating a new <font size="2" face="Courier New">TransportClientEndpointBehavior</font> with the <font size="2" face="Courier New">CredentialType</font> of <font size="2" face="Courier New">TransportClientCredentialType.Saml</font>, and setting the <font size="2" face="Courier New">SamlToken</font> property to our <font size="2" face="Courier New">samlToken</font>.&#160; Mission accomplished!&#160; (Note: since I changed the variable name to <font size="2" face="Courier New">samlCredentials</font>, but sure and update the code below where the <font size="2" face="Courier New">TransportClientEndpointBehavior</font>&#160; is added as a behavior.)</p>  <p>Feels good.&#160; Now all we have to do is run it!</p>  <p><strong><u>Wrapping Up</u></strong></p>  <p>Alright, so now we’re ready to run it.&#160; Grab the source code below.&#160; When you run it, be sure and update YOURSERVICENAMESPACE (two instances) and YOURISSUERSECRET (one instance).&#160; Also, be sure to start the projects in the following order:</p>  <ol>   <li>SelfSTS – we need to make sure our STS is running first. </li>    <li>Service – when this starts it will grab the SAML token from SelfSTS, then connect to the Service Bus endpoint as a listener. </li>    <li>Client – when this starts it will use the SharedSecret to connect to the Service Bus as a sender. </li> </ol>  <p>When the Service starts and successfully connects as a listener, it should look like this:</p>  <p><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2010/11/image5.png" width="677" height="138" /></p>  <p>After you startup the Client and echo some text, you’ll see the text reflected in the console window:</p>  <p><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.wadewegner.com/wordpress/2010/11/image6.png" width="677" height="174" /></p>  <p>And that’s it!</p>  <p>Now, the whole purpose of this is to highlight how to leverage the SAML token within the <font size="2" face="Courier New">TransportClientEndpointBehavior</font> class.&#160; Obviously you’ll want to use something like ADFS 2.0 and not the SelfSTS in a production, but fortunately I can refer you to my <strong>disclaimer</strong> above and wish you good luck!</p>  <p>Hope this helps!</p>  <p>Special thanks to <a href="http://blogs.msdn.com/b/vbertocci/" target="_blank">Vittorio Bertocci</a> and <a href="http://blogs.msdn.com/b/sskier/" target="_blank">Maciej (&quot;Ski&quot;) Skierkowski</a> for their help, and <a href="http://www.scottseely.com/Blog.aspx" target="_blank">Scott Seely</a> for asking the question that got me to pull this together.</p> <iframe style="padding-bottom: 0px; background-color: #fcfcfc; padding-left: 0px; width: 98px; padding-right: 0px; height: 115px; padding-top: 0px" title="Preview" marginheight="0" src="http://cid-952ba2b9cf071aa0.office.live.com/embedicon.aspx/.Public/EchoSampleWithSamlAndSelfSTS.zip" frameborder="0" marginwidth="0" scrolling="no"></iframe>
