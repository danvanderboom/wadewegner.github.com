--- 
layout: post
title: Host WCF Services in IIS with Service Bus Endpoints
categories: 
- .NET 4.0
- Azure AppFabric
- Cloud
- Service Bus
- WCF
tags: []

status: publish
type: post
published: true
meta: 
  _sexybookmarks_shortUrl: http://bit.ly/9JUlTf
  _sexybookmarks_permaHash: 07698751a76adc66442eaa1e1599c5f3
  dsq_thread_id: "609465960"
---
<div style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; padding-left: 5px; padding-right: 5px; font-size: 12px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><strong>Update:</strong> To see how to leverage Windows Azure AppFabric Autostart to activate the WCF Service, please see <a href="http://www.wadewegner.com/2010/08/autostart-wcf-services-to-expose-them-as-service-bus-endpoints/" target="_blank">AutoStart WCF Services to Expose them as Service Bus Endpoints</a>.</div> <p><br>Vishal Chowdhary, a Senior Test Lead on the Azure AppFabric team, recently posted a whitepaper on <a href="http://code.msdn.microsoft.com/ServiceBusDublinIIS" target="_blank">hosting WCF services with Service Bus endpoints from IIS</a>.&nbsp; This whitepaper provides two solutions to a (previously) significant challenge in hosting WCF services in IIS that connect to the Azure AppFabric Service Bus.</p> <p>The primary challenge is activation. As Vishal writes, “For the on-premise WCF service to start receiving messages from the Service Bus in the cloud (aka Relay Service), the on-premises service opens an outbound port and creates a bidirectional socket for communication.&nbsp; It connects to the Service Bus, authenticates itself, and starts listening to calls from the relay service before the client sends its requests.”&nbsp; He goes on to say that “IIS/WAS relies on message-based activation &amp; will launch the host only after the first request comes in.”&nbsp; Consequently, <b>until the first message is received by IIS the service will never establish a connection to the Service Bus</b>; with no connection to the Service Bus, <b>it will never receive a message</b>.&nbsp; A bit of a dilemma.</p> <p>In the whitepaper, Vishal points out two ways to resolve this challenge:</p> <ul type="square"> <li>IIS Application Warm-Up  <li>ASP.NET 4.0 Auto-Start </li></ul> <p>In this post, I’m going to highlight exactly how to go about using <strong>IIS Application Warm-Up to get a WCF service hosted in IIS 7.5 to receive messages from the Service Bus</strong>.&nbsp; This post borrows heavily from Visha's whitepaper; I strongly suggest you spend the time to read the entire paper.</p> <ol> <li>If you’re using .NET 4.0, you must <a href="http://www.wadewegner.com/2010/05/net-framework-4-0-and-the-azure-appfabric-sdk/" target="_blank">setup .NET 4.0 to work with the Azure AppFabric SDK</a>.  <li>Create a new ASP.NET Web Application project called <strong>EchoSample</strong> in Visual Studio 2010 using .NET 4.0.  <li>To validate this approach, we want this project hosted in IIS.&nbsp; Right-click the project and choose Properties.&nbsp; Select the Web tab, and switch from <b>Use Visual Studio Development Server</b> to <b>Use Local IIS Web server</b> and click <b>Create Virtual Directory.</b>  <li>Add the Microsoft.ServiceBus reference from the “C:%Program Files%Windows Azure platform AppFabric SDKV1.0Assemblies” folder.  <li>You have to create a custom BehaviorExtensionElement for the ServiceRegistrySettings to make the discoverability policy ‘Public’ in the configuration file.&nbsp; Consequently, we need to create a class that we’ll call MyServiceRegistrySettingsElement that inherits the BehaviorExtensionElement. </li></ol> <div style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; min-height: 40px; padding-left: 5px; width: 600px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> MyServiceRegistrySettingsElement : BehaviorExtensionElement
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">override</span> Type BehaviorType
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    {
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">get</span> { <span style="color: #0000ff">return</span> <span style="color: #0000ff">typeof</span>(ServiceRegistrySettings); }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">protected</span> <span style="color: #0000ff">override</span> <span style="color: #0000ff">object</span> CreateBehavior()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    {
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">return</span> <span style="color: #0000ff">new</span> ServiceRegistrySettings()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        {
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            DiscoveryMode = <span style="color: #0000ff">this</span>.DiscoveryMode,
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            DisplayName = <span style="color: #0000ff">this</span>.DisplayName
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        };
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    [ConfigurationProperty("<span style="color: #8b0000">discoveryMode</span>", DefaultValue = DiscoveryType.Private)]
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">public</span> DiscoveryType DiscoveryMode
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">get</span> { <span style="color: #0000ff">return</span> (DiscoveryType)<span style="color: #0000ff">this</span>["<span style="color: #8b0000">discoveryMode</span>"]; }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">set</span> { <span style="color: #0000ff">this</span>["<span style="color: #8b0000">discoveryMode</span>"] = <span style="color: #0000ff">value</span>; }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    [ConfigurationProperty("<span style="color: #8b0000">displayName</span>")]
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> DisplayName
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">get</span> { <span style="color: #0000ff">return</span> (<span style="color: #0000ff">string</span>)<span style="color: #0000ff">this</span>["<span style="color: #8b0000">displayName</span>"]; }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">set</span> { <span style="color: #0000ff">this</span>["<span style="color: #8b0000">displayName</span>"] = <span style="color: #0000ff">value</span>; }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">}</pre></div>
<ol start="6">
<li>Now, let’s add a new WCF Service called <strong>EchoService</strong> to the project.&nbsp; Remove the existing method in the ServiceContract and create the following GetData method in the IEchoService.cs file. </li></ol>
<div style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; padding-left: 5px; width: 600px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">[OperationContract]
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">string</span> GetData(<span style="color: #0000ff">int</span> <span style="color: #0000ff">value</span>);</pre></div>
<ol start="7">
<li>Also, update the EchoService.svc.cs with the implementation of the GetData method. </li></ol>
<div style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; min-height: 40px; padding-left: 5px; width: 600px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> GetData(int value)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">if</span> (value &lt; 0)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> ApplicationException("<span style="color: #8b0000">Negative values not allowed!!!</span>");
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"></pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    Thread.Sleep(value);
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">return</span> <span style="color: #0000ff">string</span>.Format("<span style="color: #8b0000">You entered: {0}</span>", value);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">}</pre></div>
<ol start="8">
<li>Now we need to update the web.config settings.&nbsp; This is fairly extensive. Be sure and replace YOUR_NAMESPACE, YOUR_ISSUER_NAME, and YOUR_ISSUER_SECRET with your own values. </li></ol>
<div style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; min-height: 40px; padding-left: 5px; width: 600px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">&lt;</span><span style="color: #800000">system.serviceModel</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  <span style="color: #0000ff">&lt;</span><span style="color: #800000">extensions</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">behaviorExtensions</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;</span><span style="color: #800000">add</span> <span style="color: #ff0000">name</span>=<span style="color: #0000ff">"ServiceRegistrySettings"</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            <span style="color: #ff0000">type</span>=<span style="color: #0000ff">"EchoSample.MyServiceRegistrySettingsElement, EchoSample,
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">                  Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;/</span><span style="color: #800000">behaviorExtensions</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  <span style="color: #0000ff">&lt;/</span><span style="color: #800000">extensions</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  <span style="color: #0000ff">&lt;</span><span style="color: #800000">services</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">clear</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">service</span> <span style="color: #ff0000">behaviorConfiguration</span>=<span style="color: #0000ff">"MyServiceTypeBehavior"</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">              <span style="color: #ff0000">name</span>=<span style="color: #0000ff">"EchoSample.EchoService"</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;</span><span style="color: #800000">endpoint</span> 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">address</span>=<span style="color: #0000ff">"http://localhost/EchoSample/EchoService.svc/LocalEchoService"</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">binding</span>=<span style="color: #0000ff">"basicHttpBinding"</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">bindingConfiguration</span>=<span style="color: #0000ff">"BasicHttpConfig"</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">name</span>=<span style="color: #0000ff">"Basic"</span> <span style="color: #ff0000">contract</span>=<span style="color: #0000ff">"EchoSample.IEchoService"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;</span><span style="color: #800000">endpoint</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">address</span>=<span style="color: #0000ff">"https://YOUR_NAMESPACE.servicebus.windows.net/EchoServiceHttp/"</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">behaviorConfiguration</span>=<span style="color: #0000ff">"sharedSecretClientCredentials"</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">binding</span>=<span style="color: #0000ff">"basicHttpRelayBinding"</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">bindingConfiguration</span>=<span style="color: #0000ff">"HttpRelayEndpointConfig"</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">name</span>=<span style="color: #0000ff">"RelayEndpoint"</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">contract</span>=<span style="color: #0000ff">"EchoSample.IEchoService"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;</span><span style="color: #800000">endpoint</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">address</span>=<span style="color: #0000ff">"sb://YOUR_NAMESPACE.servicebus.windows.net/EchoServiceNetTcp/"</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">behaviorConfiguration</span>=<span style="color: #0000ff">"sharedSecretClientCredentials"</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">binding</span>=<span style="color: #0000ff">"netTcpRelayBinding"</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">bindingConfiguration</span>=<span style="color: #0000ff">"NetTcpRelayEndpointConfig"</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">name</span>=<span style="color: #0000ff">"RelayEndpoint"</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #ff0000">contract</span>=<span style="color: #0000ff">"EchoSample.IEchoService"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;/</span><span style="color: #800000">service</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  <span style="color: #0000ff">&lt;/</span><span style="color: #800000">services</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  <span style="color: #0000ff">&lt;</span><span style="color: #800000">bindings</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">basicHttpBinding</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;</span><span style="color: #800000">binding</span> <span style="color: #ff0000">name</span>=<span style="color: #0000ff">"BasicHttpConfig"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;/</span><span style="color: #800000">basicHttpBinding</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #008000">&lt;!--service bus binding--&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">basicHttpRelayBinding</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;</span><span style="color: #800000">binding</span> <span style="color: #ff0000">name</span>=<span style="color: #0000ff">"HttpRelayEndpointConfig"</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">security</span> <span style="color: #ff0000">relayClientAuthenticationType</span>=<span style="color: #0000ff">"RelayAccessToken"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;/</span><span style="color: #800000">binding</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;/</span><span style="color: #800000">basicHttpRelayBinding</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">netTcpRelayBinding</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;</span><span style="color: #800000">binding</span> <span style="color: #ff0000">name</span>=<span style="color: #0000ff">"NetTcpRelayEndpointConfig"</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">security</span> <span style="color: #ff0000">relayClientAuthenticationType</span>=<span style="color: #0000ff">"RelayAccessToken"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;/</span><span style="color: #800000">binding</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;/</span><span style="color: #800000">netTcpRelayBinding</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  <span style="color: #0000ff">&lt;/</span><span style="color: #800000">bindings</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  <span style="color: #0000ff">&lt;</span><span style="color: #800000">behaviors</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">endpointBehaviors</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;</span><span style="color: #800000">behavior</span> <span style="color: #ff0000">name</span>=<span style="color: #0000ff">"sharedSecretClientCredentials"</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">transportClientEndpointBehavior</span> <span style="color: #ff0000">credentialType</span>=<span style="color: #0000ff">"SharedSecret"</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">          <span style="color: #0000ff">&lt;</span><span style="color: #800000">clientCredentials</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            <span style="color: #0000ff">&lt;</span><span style="color: #800000">sharedSecret</span> <span style="color: #ff0000">issuerName</span>=<span style="color: #0000ff">"YOUR_ISSUER_NAME"</span> 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">                          <span style="color: #ff0000">issuerSecret</span>=<span style="color: #0000ff">"YOUR_ISSUER_SECRET"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">          <span style="color: #0000ff">&lt;/</span><span style="color: #800000">clientCredentials</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">&lt;/</span><span style="color: #800000">transportClientEndpointBehavior</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">ServiceRegistrySettings</span> <span style="color: #ff0000">discoveryMode</span>=<span style="color: #0000ff">"Public"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;/</span><span style="color: #800000">behavior</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;/</span><span style="color: #800000">endpointBehaviors</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">serviceBehaviors</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;</span><span style="color: #800000">behavior</span> <span style="color: #ff0000">name</span>=<span style="color: #0000ff">"MyServiceTypeBehavior"</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">serviceMetadata</span> <span style="color: #ff0000">httpGetEnabled</span>=<span style="color: #0000ff">"true"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">serviceDebug</span> <span style="color: #ff0000">includeExceptionDetailInFaults</span>=<span style="color: #0000ff">"true"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;/</span><span style="color: #800000">behavior</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;/</span><span style="color: #800000">serviceBehaviors</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  <span style="color: #0000ff">&lt;/</span><span style="color: #800000">behaviors</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">&lt;/</span><span style="color: #800000">system.serviceModel</span><span style="color: #0000ff">&gt;</span></pre></div><br>
<p>At this point, once you compile and build the solution, the service will not automatically connect to the Service Bus; this is because IIS/WAS waits until the first service call to activate.&nbsp; Consequently, if you load the WCF service in the browser it will activate the service and establish a connection to the Service Bus (you can confirm by checking <a title="https://acsint.servicebus.windows.net/" href="https://YOUR_NAMESPACE.servicebus.windows.net/">https://YOUR_NAMESPACE.servicebus.windows.net/</a>).&nbsp; So, we’re close, but not yet there.</p>
<p>To get the service to automatically establish the connection to the Service Bus, we’ll use the <b>Application Warm-Up</b> extension for IIS 7.5.</p>
<ol>
<li>Download and install the <a href="http://www.iis.net/download/applicationwarmup" target="_blank">Application Warm-Up extension for IIS 7.5</a>.&nbsp; This gives us the ability to proactively load and initialize processes before the first request arrives.&nbsp; In addition to improving responsiveness it also gives us the ability to connect our WCF service to the Azure AppFabric Service Bus. 
<li>In IIS, select your virtual application EchoSample.&nbsp; Double-click the <strong>Application Warm-Up </strong>feature, and click <strong>Settings</strong>.&nbsp; Check the <strong>Start Application Pool ‘ASP.NET v4.0’ when service started</strong> checkbox. </li></ol>
<p><a href="http://images.wadewegner.com/wordpress/2010/05/image2.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Application Warm-Up settings" border="0" alt="Application Warm-Up settings" src="http://images.wadewegner.com/wordpress/2010/05/image_thumb.png" width="350" height="317"></a></p>
<ol start="3">
<li>Add a new request to register EchoService.svc as a warm-up request for the application.&nbsp; Right-click and choose <strong>Add Request</strong>.&nbsp; Enter EchoService.svc, and click OK.&nbsp; You should now see it in the Request URL list. </li></ol>
<p><a href="http://images.wadewegner.com/wordpress/2010/05/image3.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Application Warm-Up add request" border="0" alt="Application Warm-Up add request" src="http://images.wadewegner.com/wordpress/2010/05/image3_thumb.png" width="350" height="312"></a></p>
<p><a href="http://images.wadewegner.com/wordpress/2010/05/image6.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Application Warm-Up" border="0" alt="Application Warm-Up" src="http://images.wadewegner.com/wordpress/2010/05/image6_thumb.png" width="457" height="133"></a></p>
<p>And that’s it!&nbsp; The service is now automatically started and “warmed up” by IIS.&nbsp; To test, recycle the Application Pool and restart the web site.&nbsp; Then, hit your Service Bus endpoint and confirm that you’re services are running.</p>
<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Publicly Listed Services" border="0" alt="Publicly Listed Services" src="http://images.wadewegner.com/wordpress/2010/05/image_thumb1.png" width="640" height="409"></p>
<p>Now, even if we restart the computer, the WCF service will reestablish the connection to the Service Bus because IIS 7.5, through the Application Warm-Up Extensions, will automatically refresh.</p>
<p>Now, to complete the test, let’s build a quick Console application to connect to the WCF service via the Service Bus.</p>
<ol>
<li>Create a new Console Application project called Client. 
<li>Add a reference to the Microsoft.ServiceBus and System.ServiceModel. 
<li>Add a link to the IEchoService.cs file in the EchoSample project.&nbsp; Right-click the project, choose Add Existing, and change Add to Add as Link. </li></ol>
<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Add Existing Item - Add As Link" border="0" alt="Add Existing Item - Add As Link" src="http://images.wadewegner.com/wordpress/2010/05/image_thumb2.png" width="562" height="480">&nbsp;</p>
<ol start="4">
<li>Update the Program.cs file with the following code.&nbsp; Be sure and replace YOUR_NAMESPACE, YOUR_ISSUER_NAME, and YOUR_ISSUER_SECRET with your own values.</li></ol>
<div style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; min-height: 40px; padding-left: 5px; width: 600px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">class</span> Program
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">static</span> <span style="color: #0000ff">void</span> Main(<span style="color: #0000ff">string</span>[] args)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    {
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #008000">// Determine the system connectivity mode based on the command line</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #008000">// arguments: -http, -tcp or -auto  (defaults to auto)</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        ServiceBusEnvironment.SystemConnectivity.Mode = GetConnectivityMode(args);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">string</span> serviceNamespace = "<span style="color: #8b0000">YOUR_NAMESPACE</span>";
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">string</span> issuerName = "<span style="color: #8b0000">YOUR_ISSUER_NAME</span>";
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">string</span> issuerSecret = "<span style="color: #8b0000">YOUR_ISSUER_SECRET</span>";
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #008000">// create the service URI based on the service namespace</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        Uri serviceUri = ServiceBusEnvironment.CreateServiceUri("<span style="color: #8b0000">sb</span>",
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            serviceNamespace, "<span style="color: #8b0000">EchoServiceNetTcp</span>");
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #008000">//Uri serviceUri = ServiceBusEnvironment.CreateServiceUri(</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #008000">//    "https", serviceNamespace, "EchoServiceHttp");</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #008000">// create the credentials object for the endpoint</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        TransportClientEndpointBehavior sharedSecretServiceBusCredential =
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            <span style="color: #0000ff">new</span> TransportClientEndpointBehavior();
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        sharedSecretServiceBusCredential.CredentialType =
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            TransportClientCredentialType.SharedSecret;
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        sharedSecretServiceBusCredential.Credentials.SharedSecret.IssuerName =
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            issuerName;
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        sharedSecretServiceBusCredential.Credentials.SharedSecret.IssuerSecret =
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            issuerSecret;
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #008000">// create the channel factory loading the configuration</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #008000">//BasicHttpRelayBinding myBinding = new BasicHttpRelayBinding();</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        NetTcpRelayBinding myBinding = <span style="color: #0000ff">new</span> NetTcpRelayBinding();
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        EndpointAddress myEndpoint = <span style="color: #0000ff">new</span> EndpointAddress(serviceUri);
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        ChannelFactory&lt;IEchoService&gt; channelFactory =
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            <span style="color: #0000ff">new</span> ChannelFactory&lt;IEchoService&gt;(myBinding, myEndpoint);
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #008000">// apply the Service Bus credentials</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        channelFactory.Endpoint.Behaviors.Add(sharedSecretServiceBusCredential);
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #008000">// create and open the client channel</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        IEchoService channel = channelFactory.CreateChannel();
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        Console.WriteLine("<span style="color: #8b0000">Enter text to echo (or [Enter] to exit):</span>");
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">string</span> input = Console.ReadLine();
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">while</span> (input != String.Empty)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        {
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            <span style="color: #0000ff">try</span>
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            {
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">                Console.WriteLine("<span style="color: #8b0000">Server echoed: {0}</span>",
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">                    channel.GetData(Int32.Parse(input)));
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            <span style="color: #0000ff">catch</span> (Exception e)
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">                Console.WriteLine("<span style="color: #8b0000">Error: </span>" + e.Message);
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            input = Console.ReadLine();
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">if</span> (((IClientChannel)channel).State != CommunicationState.Faulted)
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            ((IClientChannel)channel).Close();
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">else</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            ((IClientChannel)channel).Abort();
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        channelFactory.Close();
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">static</span> ConnectivityMode GetConnectivityMode(<span style="color: #0000ff">string</span>[] args)
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">foreach</span> (<span style="color: #0000ff">string</span> arg <span style="color: #0000ff">in</span> args)
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            <span style="color: #0000ff">if</span> (arg.Equals("<span style="color: #8b0000">/auto</span>", StringComparison.InvariantCultureIgnoreCase)
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">                 || arg.Equals("<span style="color: #8b0000">-auto</span>", StringComparison.InvariantCultureIgnoreCase))
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            {
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">                <span style="color: #0000ff">return</span> ConnectivityMode.AutoDetect;
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (arg.Equals("<span style="color: #8b0000">/tcp</span>", StringComparison.InvariantCultureIgnoreCase)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">                 || arg.Equals("<span style="color: #8b0000">-tcp</span>", StringComparison.InvariantCultureIgnoreCase))
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">                <span style="color: #0000ff">return</span> ConnectivityMode.Tcp;
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (arg.Equals("<span style="color: #8b0000">/http</span>", StringComparison.InvariantCultureIgnoreCase)
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">                 || arg.Equals("<span style="color: #8b0000">-http</span>", StringComparison.InvariantCultureIgnoreCase))
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            {
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">                <span style="color: #0000ff">return</span> ConnectivityMode.Http;
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">            }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">return</span> ConnectivityMode.AutoDetect;
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"></pre></div><br>
<p>When you run the console application, it will connect to your WCF service through the Service Bus.&nbsp; Run it to validate. You can also uncomment some of the code to use BasicHttpRelayBinding instead of NetTcpRelayBinding to try out a different configuration.</p>
<p>The ability to host a WCF service in IIS that exposes itself on the Service Bus is a significant milestone.&nbsp; This opens up a number of fantastic opportunities and scenarios that otherwise would have been extremely difficult to accomplish.</p>
