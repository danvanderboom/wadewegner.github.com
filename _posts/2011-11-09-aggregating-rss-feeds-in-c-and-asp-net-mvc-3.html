--- 
layout: post
title: Aggregating RSS Feeds in C# and ASP.NET MVC 3
categories: 
- ASP.NET
- C#
- MVC3
tags: []

status: publish
type: post
published: true
meta: 
  _topsy_long_url: http://www.wadewegner.com/2011/11/aggregating-rss-feeds-in-c-and-asp-net-mvc-3/
  topsy_short_url: http://bit.ly/tcNhF7
  dsq_thread_id: "609465507"
---
<p>I’m working on a Windows Phone project that requires me to surface up multiple RSS feeds as a single source. I needed a way to do this quickly and easily, and with a little help from friends on Twitter (particularly a suggestion from <a href="http://twitter.com/bertcraven" target="_blank">@bertcraven</a>) I found a nice way to accomplish this using the <font face="Courier New"><strong>SyndicationFeed</strong></font> in <font face="Courier New"><strong>System.ServiceModel.Syndication</strong></font>.</p>  <p>I’ve detailed the steps below, but if you want to get to the heart of it then here’s the code to get this working:</p>  <pre class="code"><span style="color: #2b91af">SyndicationFeed </span>mainFeed = <span style="color: blue">new </span><span style="color: #2b91af">SyndicationFeed</span>();
<span style="color: #2b91af">List</span>&lt;<span style="color: blue">string</span>&gt; feeds = <span style="color: blue">new </span><span style="color: #2b91af">List</span>&lt;<span style="color: blue">string</span>&gt;();
<span style="clear: both">
feeds.Add(<span style="color: #a31515">&quot;http://feeds2.feedburner.com/WadeWegner&quot;</span>);
feeds.Add(<span style="color: #a31515">&quot;http://www.nickharris.net/feed/&quot;</span>);
feeds.Add(<span style="color: #a31515">&quot;http://feeds.feedburner.com/ntotten&quot;</span>);
feeds.Add(<span style="color: #a31515">&quot;http://michaelwasham.com/feed/&quot;</span>);
feeds.Add(<span style="color: #a31515">&quot;http://blogs.msdn.com/b/hpctrekker/rss.aspx&quot;</span>);
<span style="clear: both">
<span style="color: blue">foreach </span>(<span style="color: blue">var </span>feed <span style="color: blue">in </span>GetRssFeeds())
{
    <span style="color: #2b91af">Uri </span>feedUri = <span style="color: blue">new </span><span style="color: #2b91af">Uri</span>(feed);
    <span style="color: #2b91af">SyndicationFeed </span>syndicationFeed;
    <span style="color: blue">using </span>(<span style="color: #2b91af">XmlReader </span>reader = <span style="color: #2b91af">XmlReader</span>.Create(feedUri.AbsoluteUri))
    {
        syndicationFeed = <span style="color: #2b91af">SyndicationFeed</span>.Load(reader);
    }

    syndicationFeed.Id = feed;

    <span style="color: #2b91af">SyndicationFeed </span>tempFeed = <span style="color: blue">new </span><span style="color: #2b91af">SyndicationFeed</span>(
        mainFeed.Items.Union(syndicationFeed.Items).OrderByDescending(u =&gt; u.PublishDate));
    mainFeed = tempFeed;
}</pre>

<p>It’s really quite simple – once you know how to do it!</p>

<p>As you iterate through the list of feeds we use LINQ to union the feeds together – in the end this produces a main feed that has all the contents. Along the way we sort the elements in a descending order based on the <strong><font face="Courier New">PublishDate</font></strong> – otherwise you’ll just get blocks from each of the feeds and nothing is sorted according to the date publish. Once this is done you end up with a main feed that you can use.</p>

<p>For me I wanted to create a service that published the aggregated feed – I chose to use ASP.NET MVC 3 for this new feed. Here are steps you can follow in order to get this working in ASP.NET MVC 3.</p>

<ol>
  <li>Create a new ASP.NET MVC 3 Web Application. I’ve called mine <strong>RssFeed</strong>.&#160; <br /><a href="http://images.wadewegner.com/wordpress/2011/11/NewProject.jpg"><img style="background-image: none; border-right-width: 0px; margin: 10px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="NewProject" border="0" alt="NewProject" src="http://images.wadewegner.com/wordpress/2011/11/NewProject_thumb.jpg" width="240" height="166" /></a> </li>

  <li>Choose an <strong>Internet Application</strong> using the <strong>Razor</strong> view engine and <strong>HTML5 semantic</strong> markup. </li>

  <li>Add <strong><font face="Courier New">System.ServiceModel</font></strong> as a reference in the application. We’ll use this with <strong><font face="Courier New">SyndicationFeed</font></strong>. </li>

  <li>Create an empty controller. I’ve called mine the <strong>RssController</strong>.&#160; <br /><a href="http://images.wadewegner.com/wordpress/2011/11/RssFeed.jpg"><img style="background-image: none; border-right-width: 0px; margin: 10px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="RssFeed" border="0" alt="RssFeed" src="http://images.wadewegner.com/wordpress/2011/11/RssFeed_thumb.jpg" width="240" height="169" /></a> </li>

  <li>We’re going to define our own <strong><font face="Courier New">ActionResult</font></strong> implementation that can emit RSS by deriving from <font face="Courier New"><strong>ActionResult</strong></font>. Inspiration and original source comes from <a href="http://www.developerzen.com/2009/01/11/aspnet-mvc-rss-feed-action-result/" target="_blank">this post</a> on Developer Zen. 

    <pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">RssActionResult </span>: <span style="color: #2b91af">ActionResult
</span>{
    <span style="color: blue">public </span><span style="color: #2b91af">SyndicationFeed </span>Feed { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: blue">public override void </span>ExecuteResult(<span style="color: #2b91af">ControllerContext </span>context)
    {
        context.HttpContext.Response.ContentType = <span style="color: #a31515">&quot;application/rss+xml&quot;</span>;

        <span style="color: #2b91af">Rss20FeedFormatter </span>rssFormatter = <span style="color: blue">new </span><span style="color: #2b91af">Rss20FeedFormatter</span>(Feed);
        <span style="color: blue">using </span>(<span style="color: #2b91af">XmlWriter </span>writer = <span style="color: #2b91af">XmlWriter</span>.Create(context.HttpContext.Response.Output))
        {
            rssFormatter.WriteTo(writer);
        }
    }
}</pre>
  </li>

  <li>We can now update the <strong><font face="Courier New">Index</font></strong> method to use the <strong><font face="Courier New">RssActionResult</font></strong> instead of the default <strong><font face="Courier New">ActionResult</font></strong> implementation. 

    <pre class="code"><span style="color: blue">public </span><span style="color: #2b91af">RssActionResult </span>Index()
{
    <span style="color: blue">return new </span><span style="color: #2b91af">RssActionResult</span>();
}</pre>
  </li>

  <li>Define a method that returns all the feeds with which you want to aggregate. You can pull from many different places – I recommend SQL Azure – but for the purposes of this demo you can just use a generic list of strings. 
    <pre class="code"><span style="color: blue">private static </span><span style="color: #2b91af">List</span>&lt;<span style="color: blue">string</span>&gt; GetRssFeeds()
{
    <span style="color: #2b91af">List</span>&lt;<span style="color: blue">string</span>&gt; feeds = <span style="color: blue">new </span><span style="color: #2b91af">List</span>&lt;<span style="color: blue">string</span>&gt;();

    feeds.Add(<span style="color: #a31515">&quot;http://feeds2.feedburner.com/WadeWegner&quot;</span>);
    feeds.Add(<span style="color: #a31515">&quot;http://www.nickharris.net/feed/&quot;</span>);
    feeds.Add(<span style="color: #a31515">&quot;http://feeds.feedburner.com/ntotten&quot;</span>);
    
    <span style="color: blue">return </span>feeds;
}</pre>
  </li>

  <li>Now we can update our Index method to iterate through the feeds and aggregate them into a single SyndicationFeed that is sorted (descending) by the publish date. 
    <pre class="code"><span style="color: blue">public </span><span style="color: #2b91af">RssActionResult </span>Index()
{
    <span style="color: #2b91af">SyndicationFeed </span>mainFeed = <span style="color: blue">new </span><span style="color: #2b91af">SyndicationFeed</span>();

    <span style="color: blue">foreach </span>(<span style="color: blue">var </span>feed <span style="color: blue">in </span>GetRssFeeds())
    {
        <span style="color: #2b91af">Uri </span>feedUri = <span style="color: blue">new </span><span style="color: #2b91af">Uri</span>(feed);
        <span style="color: #2b91af">SyndicationFeed </span>syndicationFeed;
        <span style="color: blue">using </span>(<span style="color: #2b91af">XmlReader </span>reader = <span style="color: #2b91af">XmlReader</span>.Create(feedUri.AbsoluteUri))
        {
            syndicationFeed = <span style="color: #2b91af">SyndicationFeed</span>.Load(reader);
        }

        syndicationFeed.Id = feed;

        <span style="color: #2b91af">SyndicationFeed </span>tempFeed = <span style="color: blue">new </span><span style="color: #2b91af">SyndicationFeed</span>(
            mainFeed.Items.Union(syndicationFeed.Items).OrderByDescending(u =&gt; u.PublishDate));
        mainFeed = tempFeed;
    }

    <span style="color: blue">return new </span><span style="color: #2b91af">RssActionResult</span>() { Feed = mainFeed };
}</pre>
  </li>

  <li>Now, hit F5 and run. Browse to http://localhost:&lt;port&gt;/rss to see the aggregated RSS feed.&#160; <br /><a href="http://images.wadewegner.com/wordpress/2011/11/RssFeed.jpg"><img style="background-image: none; border-right-width: 0px; margin: 10px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="RssFeed" border="0" alt="RssFeed" src="http://images.wadewegner.com/wordpress/2011/11/RssFeed_thumb.jpg" width="640" height="451" /></a> </li>
</ol>

<p>And that’s it!</p>

<p>There’s certainly more you can do with this – in fact, given the cost it takes to aggregate a large number of feeds, I’ve started to take the aggregated feed and store it in Windows Azure blob storage attached to the Content Delivery Network (CDN). The code to do this is similar to the following:</p>

<pre class="code"><span style="color: #2b91af">StringBuilder </span>builder = <span style="color: blue">new </span><span style="color: #2b91af">StringBuilder</span>();
<span style="color: blue">using </span>(<span style="color: #2b91af">XmlWriter </span>writer = <span style="color: #2b91af">XmlWriter</span>.Create(builder))
{
    mainFeed.SaveAsRss20(writer);
    <span style="color: blue">string </span>rssFeed = builder.ToString();

</span>}
<span style="color: green">// write to Windows Azure blob storage</span></pre>

<pre class="code"><font face="Calibri">You might consider doing something similar.</font></pre>

<pre class="code"><font face="Calibri">I hope this helps!</font></pre>
