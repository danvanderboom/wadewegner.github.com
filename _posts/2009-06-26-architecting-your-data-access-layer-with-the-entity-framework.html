--- 
layout: post
title: Architecting Your Data Access Layer with the Entity Framework
categories: 
- Architecture
- Entity Framework
tags: []

status: publish
type: post
published: true
meta: 
  aktt_notify_twitter: "yes"
  _edit_last: "1"
  _sexybookmarks_shortUrl: http://bit.ly/912IIW
  _sexybookmarks_permaHash: 843528ea75c16b9fc279f9e5a3078106
  dsq_thread_id: "609465377"
---
<p>I had the pleasure to co-present with one of my fellow evangelists, <a href="http://davebost.com/blog/">Dave Bost</a>, on architecting and developing with the <a href="http://www.bing.com/search?q=ADO.NET+Entity+Framework+&amp;form=QBRE&amp;qs=n">ADO.NET Entity Framework</a> this week.&#160; I focused on application architecture topics while Dave focused on developing applications.</p>  <p>I think we can all agree – and if not, please let me know why – that the Entity Framework provides some awesome capabilities – mapping your conceptual schema to your data schema, isolation from the relational database and database schema, <a href="http://msdn.microsoft.com/en-us/library/bb896269.aspx">change tracking and identity resolution</a>, full query comprehension and <a href="http://blogs.msdn.com/adonet/archive/2008/03/27/ado-net-entity-framework-performance-comparison.aspx">optimization</a>, and more.&#160; Yet, despite these features, it is difficult to figure out how and where to include the Entity Framework in your application architecture.</p>  <p>In preparation for this talk, I spent a lot of time looking at different strategies and architectures for using your <a href="http://www.bing.com/search?q=data+access+layer&amp;mkt=en-us&amp;FORM=IE8SRC">data access layer</a> (DAL) and the Entity Framework – or any <a href="http://www.bing.com/search?q=object-relational+mapping&amp;form=QBRE&amp;qs=n">O/RM tool</a>, for that matter.&#160; In the end, I settled on three approaches – certainly there are other patterns and approaches, but I found these to be the most relevant:</p>  <ol>   <li>Entity Framework as the DAL </li>    <li>Full encapsulation of the Entity Framework </li>    <li>Partial encapsulation of the Entity Framework </li> </ol>  <p>Let me spell it out in a little more detail, as well as highlight what I feel are the different pro’s and con’s.</p>  <h1>Entity Framework as the Data Access Layer</h1>  <p>With this approach, you opt to use the Entity Framework as your data access layer.&#160; This is a perfectly legitimate approach, and comes with a host of benefits in many situations.&#160; Here’s a picture of the architecture:</p>  <p><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="EF" border="0" alt="EF" src="http://images.wadewegner.com/wordpress/2010/04/EF.png" width="596" height="304" /> </p>  <p>As you can see, in this architecture aspects of the Entity Framework – like entities and the entity framework object context – are scattered throughout the various tiers.&#160; This approach has many benefits, but it also introduces some challenges.</p>  <p>- Pro’s:</p>  <ul>   <li>Excellent isolation from the DB schema </li>    <li>Independence from the relational database </li>    <li>Object services, namely identity and change tracking </li>    <li>Full query comprehension and optimization </li> </ul>  <p>- Con’s:</p>  <ul>   <li>In .NET 3.5 SP1 the “object first” approach is not well supported (updated in EF 4.0) </li>    <li>Difficult to switch your O/RM, as you are tightly coupled to the Entity Framework </li>    <li>Limited support for data validation </li> </ul>  <p>If you aren’t offended by the scattering of your entities and entity contexts throughout your application tiers, then this is a perfectly valid architecture.&#160; That said, most people probably recognize that technology changes, and an application that works perfectly well with Entity Framework today may need to move to a newer technology in the future.&#160; Consequently, you may want to look at an approach that encapsulates the Entity Framework, so that you separate your concerns and have high cohesion in your tiers without tight coupling.</p>  <h1>Full Encapsulation of the Entity Framework</h1>  <p>There are many benefits to encapsulation.&#160; We have talked and read about ensuring a <a href="http://www.bing.com/search?q=separation+of+concerns&amp;mkt=en-us&amp;FORM=IE8SRC">separation of concerns</a> – e.g. <a href="http://en.wikipedia.org/wiki/Cohesion_(computer_science)">high cohesion</a>, <a href="http://en.wikipedia.org/wiki/Loose_coupling">loose coupling</a> – for years now, and for good reason.&#160; Typically we want to reduce the tight coupling throughout application so that tools like Entity Framework don’t proliferate through all the tiers of our application.&#160; This helps make our code more testable, and allows us to utilize techniques such as <a href="http://en.wikipedia.org/wiki/Inversion_of_control">Inversion of Control</a> and <a href="http://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>.</p>  <p>At the same time, fully encapsulating a tool like Entity Framework also comes with some costs.&#160; If the real value of this tool is the ability to empower developers to quickly build powerful applications that are fully optimized against your database, then full encapsulation may inhibit some of the capabilities.</p>  <p>- Pro’s:</p>  <ul>   <li>Simplified queries </li>    <li>POCO objects </li>    <li>ORM &amp; database agnostic </li>    <li>No references to Entity Framework </li>    <li>Isolation of SQL queries </li> </ul>  <p>- Con’s:</p>  <ul>   <li>Loss of change tracking and identity management with Entity Framework </li>    <li>Additional object materialization of business objects </li>    <li>No query composition; simple LINQ enumeration queries </li> </ul>  <p>Again, this is not a full laundry list, but hopefully it provides some of the different benefits and challenges.&#160; Fortunately, there’s a third path you can take, which is a hybrid of the two – I call this partial encapsulation.</p>  <h1>Partial Encapsulation of the Entity Framework</h1>  <p>When you decide to partially encapsulate the Entity Framework, you acknowledge the benefits of the separation of concerns and do what you can to loosely couple your tiers.&#160; But you also try to preserve the advantages of a tool like the Entity Framework.&#160; In this scenario, you might expose your entities to the different tiers of your application, but encapsulate the rest of the Entity Framework in your DAL.&#160; When you return data from the DAL, you would simply use one of the three techniques: IEnumerable, IQueryable, or ObjectQuery.&#160; Other than the last technique, you aren’t exposing aspects of the Entity Framework – other than the entities themselves – to any other tiers.&#160; This preserves the loose coupling, but allows you to leverage the real value of the Entity Framework.</p>  <p>- Pro’s:</p>  <ul>   <li>Query composition </li>    <li>Identity resolution &amp; changing tracking </li>    <li>Some independence from O/RM tool </li> </ul>  <p>- Con’s:</p>  <ul>   <li>Use of Entity Framework entities has implications on business layer </li>    <li>Lack of isolation of SQL queries – spread throughout the various tiers </li> </ul>  <p>Partial encapsulation is a pragmatic approach to this problem, and it’s a technique the I have seen many customers and partners utilize very successfully.&#160; In the end, the approach you choose depends on your situation.&#160; All three of these approaches are perfectly valid, but aren’t necessarily valid in every situation.</p>  <p>Below are the slides I used during the presentation.&#160; I am sure that this is a presentation I’ll give again in the future, so expect to see updates and/or changes.</p>  <div style="text-align: left; width: 425px" id="__ss_1638838"><a style="margin: 12px 0px 3px; display: block; font: 14px helvetica,arial,sans-serif; text-decoration: underline" title="ADO.NET Entity Framework &amp; Your Data Access Layer" href="http://www.slideshare.net/wwegner/adonet-entity-framework-your-data-access-layer?type=powerpoint">ADO.NET Entity Framework &amp; Your Data Access Layer</a> <object style="margin:0px" width="425" height="355"> <param name="movie" value="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=entityframeworkyourdal-090625092602-phpapp01&amp;rel=0&amp;stripped_title=adonet-entity-framework-your-data-access-layer" /> <param n
ame="allowFullScreen" value="true" /> <param name="allowScriptAccess" value="always" /> <embed src="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=entityframeworkyourdal-090625092602-phpapp01&amp;rel=0&amp;stripped_title=adonet-entity-framework-your-data-access-layer" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="355"></embed> </object>    <div style="font-family: tahoma,arial; height: 26px; font-size: 11px; padding-top: 2px">View more documents from <a style="text-decoration: underline" href="http://www.slideshare.net/wwegner">Wade Wegner</a>.</div> </div>  <p>I’d love to hear your feedback, so please leave me a comment or message.</p>  <p>I hope this helps!</p>
