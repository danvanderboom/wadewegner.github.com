--- 
layout: post
title: Detecting Expired PKI Certificates
categories: 
- C#
- Certificates
- PKI
- SSL
- Windows Azure
tags: []

status: publish
type: post
published: true
meta: 
  _wpas_done_all: "1"
  _topsy_long_url: http://www.wadewegner.com/2013/02/detecting-expired-pki-certificates/
  topsy_short_url: http://bit.ly/Ytdb7Z
  dsq_thread_id: "1101015289"
---
<p>Yesterday Windows Azure experienced a worldwide disruption in many services due to an expired PKI certificate for Windows Azure storage. Mary Jo Foley’s article <a href="http://www.zdnet.com/windows-azure-storage-issue-expired-https-certificate-possibly-at-fault-7000011705/" target="_blank">Windows Azure storage issue: Expired HTTPS certificate possibly at fault</a> provides the best coverage of the event as it unfolded. You can also take a look at a few threads on the <a href="http://social.msdn.microsoft.com/Forums/en-US/windowsazuredata/thread/751c85c5-b3b5-43ba-9d5b-770472ad79e1" target="_blank">Windows Azure forum</a> and <a href="http://stackoverflow.com/questions/15033020/windows-azure-storage-certificate-expired" target="_blank">Stack Overflow</a> that provide a lot of commentary on the event. The effects of this disruption rippled through most of the other Windows Azure services. Even if you modified your application to use HTTP instead of HTTPS it’s likely you still had issues given that the rest of the platform was crippled by the expired certificate.</p> <p>It’s disappointing this happened but highlights a pretty common situation. This has nothing to do with the merits of the Windows Azure storage service or any other parts of the platform – this is an operations management issue, plain and simple. The irony is that, as a number of folks <a href="https://twitter.com/larsw/status/305375364534902784" target="_blank">including Lars Wilhelmsen</a> have pointed out, there are tools like Microsoft SCOM that provide a Certificate Management Pack that can notify operations of expiring certificates. I can’t imagine the operations team at Windows Azure doesn’t use some kind of tool to manage expiring certificates.</p> <p>As a developer, I found myself curious to see just how hard it is to determine the expiration of a certificate by checking the URI. Turns out, it’s pretty simple by using <font face="Courier New">System.Net.ServicePoint</font> which provides connection management for HTTP/S connections.</p><pre class="code"><span style="color: blue">private string </span><span style="color: black">GetSSLExpiryDate()
{
    </span><span style="color: blue">string </span><span style="color: black">url = </span><span style="color: #a31515">"https://www.aditicloud.com/"</span><span style="color: black">;
    </span><span style="color: blue">var </span><span style="color: black">request = </span><span style="color: #2b91af">WebRequest</span><span style="color: black">.Create(url) </span><span style="color: blue">as </span><span style="color: #2b91af">HttpWebRequest</span><span style="color: black">;
    </span><span style="color: blue">var </span><span style="color: black">response = request.GetResponse();

    </span><span style="color: blue">if </span><span style="color: black">(request.ServicePoint.Certificate != </span><span style="color: blue">null</span><span style="color: black">)
    {
        </span><span style="color: blue">return </span><span style="color: black">request.ServicePoint.Certificate.GetExpirationDateString();
    }
    </span><span style="color: blue">else
    </span><span style="color: black">{
        </span><span style="color: blue">return string</span><span style="color: black">.Empty;
    }
}</span></pre>
<p>Pretty simple. What’s hard is the practice of managing and tracking these sorts of things.</p>
<p>I would expect that Microsoft will ensure that this kind of problem never happens again. It’s embarrassing yet solvable. Yet it exposes an issue that most of us will also have to account for – expiring certificates. If it can happen to Microsoft, it can happen to us too.</p>
