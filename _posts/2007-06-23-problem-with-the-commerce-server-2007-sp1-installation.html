--- 
layout: post
title: Problem with the Commerce Server 2007 SP1 Installation
categories: []

tags: []

status: publish
type: post
published: true
meta: 
  _sexybookmarks_shortUrl: http://bit.ly/dg1z0B
  _sexybookmarks_permaHash: 9af20a78087d107d356e6cf10bfa9c19
  dsq_thread_id: "610629728"
---
<p>As was <a href="http://www.wadewegner.com/PermaLink,guid,1904b877-d1d4-4841-87d2-8b4ecd826965.aspx">announced yesterday</a>, Service Pack 1 has been released for Commerce Server 2007.&nbsp; This service pack includes support for Windows Vista, the ability to create <a href="http://msdn2.microsoft.com/en-us/asp.net/aa336618.aspx" target="_blank">web application projects in Visual Studio 2005</a>, performance and security enhancements, and a slew of bug fixes.</p> <p>I have detailed the process for installing SP1 and upgrading your CS sites in the following posts: <a href="http://www.wadewegner.com/PermaLink,guid,3e9bb1c9-4c0f-4468-af92-68ecf4db73d7.aspx">Commerce Server 2007 Service Pack 1 (SP1) Walkthrough</a>&nbsp;and <a href="http://www.wadewegner.com/PermaLink,guid,d4fe3f01-c318-4958-b46b-4e2a4b8827c0.aspx">Commerce Server 2007 Upgrade Wizard (post SP1 install) Walkthrough</a>.</p> <p>While installing SP1 I encountered a rather strange problem.&nbsp; Let me try to explain how the problem occurred, and what I did to resolve it.</p> <p>To begin, I&nbsp;decided to upgrade my Commerce Server 2007 virtual machine&nbsp;to SP1.&nbsp; To begin, I did the following:</p> <ol> <li>Followed the steps I detail in my post <a href="http://www.wadewegner.com/PermaLink,guid,3e9bb1c9-4c0f-4468-af92-68ecf4db73d7.aspx">Commerce Server 2007 Service Pack 1 (SP1) Walkthrough</a>.&nbsp; In fact, these screen shots were taken during this initial installation of SP1.</li> <li>After I installed SP1, I immediately launched the Upgrade Wizard.</li> <li>For the most part, I followed the steps outlined in my post <a href="http://www.wadewegner.com/PermaLink,guid,d4fe3f01-c318-4958-b46b-4e2a4b8827c0.aspx">Commerce Server 2007 Upgrade Wizard (post SP1 install) Walkthrough</a>.&nbsp; However, instead of upgrading both my StarterSite and CSharpSite, I only upgraded my CSharpSite and then rebooted my machine.</li></ol> <p>Why did I reboot the machine after only upgrading one site?&nbsp; Well, I'm not exactly sure.&nbsp; Part of me wanted to see what would happen with only one site upgraded, and another part wanted to upgrade one site at a time while rebooting in-between.&nbsp; Regardless, I rebooted after installing only the CSharpSite.</p> <p>After rebooting, here was my first indication that something was wrong.<br /><br /><img height="119" alt="At least one service or driver failed during system startup." src="http://images.wadewegner.com/wordpress/content/binary/WindowsLiveWriter/IssueswithCommerceServer2007SP1Installat_A115/Error_1.gif" width="623"> </p> <p>So, I immediately went to the Event Viewer.&nbsp; I saw a number of errors involving the SQLSERVERAGENT, Commerce Server, and ENTSSO.&nbsp; Here's a look at the various errors in the log (the reboot occurred around 10:52 am ... some of these other errors were thrown from my playing around before I resolved the problem):</p> <p><img height="222" alt="Event Viewer errors" src="http://images.wadewegner.com/wordpress/content/binary/WindowsLiveWriter/IssueswithCommerceServer2007SP1Installat_A115/Errors_1.gif" width="635"> </p> <p>I should note that the system was previously very healthy, as I use this VM all the time while writing the book <em><a href="http://www.wadewegner.com/PermaLink,guid,96042b54-9859-4ea8-8497-5dab8033f405.aspx" target="_blank">Professional Commerce Server 2007</a></em> for WROX.&nbsp; In fact, I had been using the computer with no problems immediately before installing the service pack.</p> <p>So, at this point it was clear that:</p> <ol> <li>The SQL Server Agent was no longer able to start-up.<br /><br /><font face="Courier New">SQLServerAgent could not be started (reason: Unable to connect to server '(local)'; SQLServerAgent cannot start).</font><br /></li> <li>Enterprise Single-Sign On (ENTSSO) was also having issues starting because it couldn't communicate to SQL Server 2005.<br /><br /><font face="Courier New">The SSO service failed to start.<br />Error Code: 0x800710D9, Unable to read from or write to the database.<br /></font></li> <li>Commerce Server was complaining that I hadn't updated the StarterSite yet (this one is to be expected, as I hadn't updated it yet):<br /><br /><font face="Courier New">Error in Commerce Administration Object : Description - 'The following resources are old. They will not function correctly until they are upgraded:<br />Product Catalog (7.1.0)<br />Marketing (7.0.0)</font></li></ol> <p>Obviously, something here is wrong, and SQL Server seemed to be at the heart of it.</p> <p>The next thing I did was try to connect to SQL Server 2005.&nbsp; Using the SQL Server Management Studio, I tried to login with my Windows credentials.&nbsp; I wasn't surprised to see that I couldn't:</p> <p><img height="175" alt="A connection was successfully established to the server, but then an error occured during the pre-login handshake. (provider: Shared Memory Provider, error: 0 - No process is on the other end of the pipe.) (Microsoft SQL Server, Error: 223)" src="http://images.wadewegner.com/wordpress/content/binary/WindowsLiveWriter/IssueswithCommerceServer2007SP1Installat_A115/SQLError_1.gif" width="611"> </p> <p>"A connection was successfully established to the server, but then an error occurred during the pre-login handshake. (provider: Shared Memory Provider, error: 0 - No process is on the other end of the pipe.) (Microsoft SQL Server, Error: 223)" (copied directly from dialog window)</p> <p>I have never seen this error before, but wasn't surprised to see that I couldn't find anything anything on <a href="http://www.google.com/search?hl=en&amp;rls=com.microsoft%3Aen-us%3AIE-SearchBox&amp;rlz=1I7GGIG&amp;q=%22A+connection+was+successfully+established+to+the+server%2C+but+then+an+error+occurred+during+the+pre-login+handshake.+%28provider%3A+Shared+Memory+Provider%2C+error%3A+0+-+No+process+is+on+the+other+end+of+the+pipe.%29+%28Microsoft+SQL+Server%2C+Error%3A+223%29%22" target="_blank">Google</a> or <a href="http://search.live.com/results.aspx?q=%22A+connection+was+successfully+established+to+the+server%2C+but+then+an+error+occurred+during+the+pre-login+handshake.+%28provider%3A+Shared+Memory+Provider%2C+error%3A+0+-+No+process+is+on+the+other+end+of+the+pipe.%29+%28Microsoft+SQL+Server%2C+Error%3A+223%29%22&amp;form=QBNO" target="_blank">Live</a> (although, hopefully this post will come up in the future).&nbsp; Sure, various iterations of the first part can be found, but nothing seems applicable to this situation.</p> <p>So, I decide to poke around.&nbsp; What bothered me was that SQL Server (MSSQLSERVER) was running yet I couldn't connect to it, and the SQL Server Agent (MSSQLSERVER) itself couldn't start.&nbsp; Even my attempts to manually start the service failed.&nbsp; Here's a look at SQL Server Configuration Manager:</p> <p><img height="122" alt="SQL Server Configuration Manager" src="http://images.wadewegner.com/wordpress/content/binary/WindowsLiveWriter/IssueswithCommerceServer2007SP1Installat_A115/Config_1.gif" width="682"> </p> <p>Also, I attempted to connect to Commerce Server by running the Upgrade Wizard ... it didn't start, nor did I receive an error.&nbsp; It simply didn't start.</p> <p>For some reason, one thing jumped out at me -- I was running as LocalSystem rather than NT AUTHORITYNetworkService.&nbsp; Could this have something to do with it?</p> <p>Not having any other ideas, I changed both SQL Server and SQL Server Agent to "Log on as" the "Network Service" (NT AUTHORITYNetworkService) instead of the LocalSystem account.&nbsp; I&nbsp;then restarted SQL Server 2005 and the SQL Server Agent.&nbsp; Lo and behold, the SQL Server Agent started-up!</p> <p><img height="123" alt="Config2" src="http://images.wadewegner.com/wordpress/content/binary/WindowsLiveWriter/IssueswithCommerceServer2007SP1Installat_A115/Config2_1.gif" width="664"> </p> <p>A little baffled, but encouraged that I was on track to resolving the problem (even if I don't understand the root cause), I tried to connect to SQL Server 2005.&nbsp; Sure enough, I was able to login to the database server and interact with the various databases.&nbsp; I also attempted&nbsp; to connect to the Commerce Server 2007 Upgrade Wizard, which immediat
ely started with no problems.</p> <p>Since I wasn't too confident with the state of the computer (given that some services still weren't started), I decided to restart the computer.&nbsp; It restarted without a single error, and I was able to run the Upgrade Wizard successfully to upgrade the StarterSite.</p> <p>At this point I don't quite know why there was a problem with the LocalSystem account after I installed SP1 for Commerce Server 2007.&nbsp; I intend to do a little more research to look into it.</p> <p>Have any of you encountered this problem?&nbsp; Can you shed some light on the situation?</p> <p>Thanks, and I hope this helps!</p>
