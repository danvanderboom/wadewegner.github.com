--- 
layout: post
title: System.Net.WebException when issuing more than two concurrent WebRequest's
categories: 
- .NET 2.0
- BizTalk Server
tags: []

status: publish
type: post
published: true
meta: 
  _sexybookmarks_shortUrl: http://bit.ly/bLjUcv
  _sexybookmarks_permaHash: 95913c072ffb8d060539de27f2887b3a
  dsq_thread_id: "609464887"
---
<p>I got caught up yesterday with a problem I should have recognized right away, but for whatever reason I didn't put the pieces together until it was pointed out by one of my co-workers.</p>  <p>I was writing a BizTalk Server 2006 orchestration that, amongst other things, sends a request to a remote server.&#160; The remote server has an application installed that accesses these requests and initiates a few local (and unimportant) processes.&#160; Information is passed to this application via the URL which is unique with each request and constructed by the orchestration.</p>  <p>Rather than use a dynamic one-way send port with the HTTP adapter, I decided to create a .NET helper project (a C# class library) and create a static method that allows me to pass in the URL and wait for a response.&#160; The contents of the response itself is unimportant; all I require is a successful response.</p>  <p>I created the following class in my helper project (simplified for clarity):</p>  <div class="csharpcode">   <pre><span class="lnum">   1:  </span><span class="kwrd">using</span> System;</pre>

  <pre><span class="lnum">   2:  </span><span class="kwrd">using</span> System.Collections.Generic;</pre>

  <pre><span class="lnum">   3:  </span><span class="kwrd">using</span> System.Text;</pre>

  <pre><span class="lnum">   4:  </span><span class="kwrd">using</span> System.Net;</pre>

  <pre><span class="lnum">   5:  </span><span class="kwrd">namespace</span> Messaging.Helper</pre>

  <pre><span class="lnum">   6:  </span>{</pre>

  <pre><span class="lnum">   7:  </span>    [Serializable]</pre>

  <pre><span class="lnum">   8:  </span>    <span class="kwrd">public</span> <span class="kwrd">class</span> Statics</pre>

  <pre><span class="lnum">   9:  </span>    {</pre>

  <pre><span class="lnum">  10:  </span>        <span class="kwrd">public</span> <span class="kwrd">void</span> CallUrl(<span class="kwrd">string</span> url)</pre>

  <pre><span class="lnum">  11:  </span>        {</pre>

  <pre><span class="lnum">  12:  </span>            WebRequest request = WebRequest.Create(url);</pre>

  <pre><span class="lnum">  13:  </span>            request.Method = <span class="str">&quot;GET&quot;</span>;</pre>

  <pre><span class="lnum">  14:  </span>            request.GetResponse();</pre>

  <pre><span class="lnum">  15:  </span>        }</pre>

  <pre><span class="lnum">  16:  </span>    }</pre>

  <pre><span class="lnum">  17:  </span>}</pre>
</div>
<style type="text/css">






.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }</style>

<br />

<p>As you can see, the static method uses the System.Net.WebRequest class to issue a request to the specified URL.&#160; To test this method, I created a command-line application that iterated 20 or so times and issued requests against the remote server.&#160; The code was similar to the following (simplified for clarity):</p>

<div class="csharpcode">
  <pre><span class="lnum">   1:  </span><span class="kwrd">using</span> System;</pre>

  <pre><span class="lnum">   2:  </span><span class="kwrd">using</span> System.Collections.Generic;</pre>

  <pre><span class="lnum">   3:  </span><span class="kwrd">using</span> System.Text;</pre>

  <pre><span class="lnum">   4:  </span><span class="kwrd">using</span> System.Net;</pre>

  <pre><span class="lnum">   5:  </span><span class="kwrd">using</span> Messaging.Helper;</pre>

  <pre><span class="lnum">   6:  </span><span class="kwrd">namespace</span> Messaging.ConsoleApp</pre>

  <pre><span class="lnum">   7:  </span>{</pre>

  <pre><span class="lnum">   8:  </span>    <span class="kwrd">class</span> Program</pre>

  <pre><span class="lnum">   9:  </span>    {</pre>

  <pre><span class="lnum">  10:  </span>        <span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)</pre>

  <pre><span class="lnum">  11:  </span>        {</pre>

  <pre><span class="lnum">  12:  </span>            <span class="kwrd">for</span> (<span class="kwrd">int</span> i = 0; i &lt; 20; i++)</pre>

  <pre><span class="lnum">  13:  </span>            {</pre>

  <pre><span class="lnum">  14:  </span>                Statics.CallUrl(<span class="str">&quot;http://www.someurl.com/&quot;</span>);</pre>

  <pre><span class="lnum">  15:  </span>            }</pre>

  <pre><span class="lnum">  16:  </span>        }</pre>

  <pre><span class="lnum">  17:  </span>    }</pre>

  <pre><span class="lnum">  18:  </span>}</pre>
</div>

<br />

<p>I immediately noticed that this code failed after it issued two concurrent requests.&#160; No matter how many times I ran it, it always was successful the first two times and then timed-out and threw an error message similar to the following:</p>

<ul>
  <pre class="csharpcode">System.Net.WebException was unhandled
Message=&quot;The operation has timed out&quot;
Source=&quot;System&quot;
StackTrace:
  at System.Net.HttpWebRequest.GetResponse()
  at ConsoleApp.Program.Helper.CallUrl() in D:TestConsoleAppProgram.cs:line 41
  at ConsoleApp.Program.Main(String[] args) in D:TestConsoleAppProgram.cs:line 20
  at System.AppDomain.nExecuteAssembly(Assembly assembly, String[] args)
  at System.AppDomain.ExecuteAssembly(String assemblyFile, Evidence assemblySecurity,
     String[] args)
  at Microsoft.VisualStudio.HostingProcess.HostProc.RunUsersAssembly()
  at System.Threading.ThreadHelper.ThreadStart_Context(Object state)
  at System.Threading.ExecutionContext.Run(ExecutionContext executionContext,
     ContextCallback callback, Object state)
  at System.Threading.ThreadHelper.ThreadStart()</pre>
</ul>

<p>Yes, I should have immediately picked up on the fact that it succeeded the first two times but then consistently failed on each additional request.&#160; Instead, I tried all kinds of different scenarios (non-static methods, multi-threaded calls, etc.).&#160; Fortunately, a co-worker stopped by and reminded me that, by design, there is a limit on the number of connections you can have to any given server.&#160; By default, this <strong>limitation is set to two!</strong></p>

<p>As soon as he said that I remembered the limitation (I guess I still have a few neurons that occasionally fire).&#160; Immediately I created an application configuration file for my command-line application and added the following (of course, I had to look-up the exact syntax):</p>

<div class="csharpcode">
  <pre><span class="lnum">   1:  </span><span class="kwrd">&lt;?</span><span class="html">xml</span> <span class="attr">version</span><span class="kwrd">=&quot;1.0&quot;</span> <span class="attr">encoding</span><span class="kwrd">=&quot;utf-8&quot;</span> ?<span class="kwrd">&gt;</span></pre>

  <pre><span class="lnum">   2:  </span><span class="kwrd">&lt;</span><span class="html">configuration</span><span class="kwrd">&gt;</span></pre>

  <pre><span class="lnum">   3:  </span>    <span class="kwrd">&lt;</span><span class="html">system.net</span><span class="kwrd">&gt;</span></pre>

  <pre><span class="lnum">   4:  </span>        <span class="kwrd">&lt;</span><span class="html">connectionManagement</span><span class="kwrd">&gt;</span></pre>

  <pre><span class="lnum">   5:  </span>            <span class="kwrd">&lt;</span><span class="html">add</span> <span class="attr">address</span><span class="kwrd">=&quot;*&quot;</span> <span class="attr">maxconnection</span><span class="kwrd">=&quot;100&quot;</span> <span class="kwrd">/&gt;</span></pre>

  <pre><span class="lnum">   6:  </span>        <span class="kwrd">&lt;/</span><span class="html">connectionManagement</span><span class="kwrd">&gt;</span></pre>

  <pre><span class="lnum">   7:  </span>    <span class="kwrd">&lt;/</span><span class="html">system.net</span><span class="kwrd">&gt;</span></pre>

  <pre><span class="lnum">   8:  </span><span class="kwrd">&lt;/</span><span class="html">configuration</span><span class="kwrd">&gt;</span></pre>
</div>

<br />

<p>This allows for up to 100 simultaneous connections to any server.&#160; When I ran my command-line application again it worked perfectly -- 20 requests were issued to the URL.</p>

<p>After poking around a little bit, I found the actual specification in the HTTP/1.1 protocol that dictates this limitation.&#160; See <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.1.4">Hypertext Transfer Protocol - Section 8.1.4</a>:</p>

<blockquote>
  <p>&quot;Clients that use persistent connections SHOULD limit the number of simultaneous connections that they maintain to a given server. A single-user client SHOULD NOT maintain more than 2 connections with any server or proxy. A proxy SHOULD use up to 2*N connections to another server or proxy, where N is the number of simultaneously active users. These guidelines are intended to improve HTTP response times and avoid congestion.&quot;</p>
</blockquote>

<p>Ah, this explains why Internet Explorer only allows me to download two files at the same time!</p>

<p>Now, in order to allow my BizTalk orchestration to proper issue more than two concurrent connections (remember, it too is just calling .NET code), I needed to modify the BTSNTSvc.exe.config file that services the BizTalk host instances.&#160; This file is found in the BizTalk Server directory under Program Files:</p>

<p><a href="http://images.wadewegner.com/wordpress/content/binary/WindowsLiveWriter/e8c3b063ce21_A687/image.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="BTSNTSvc.exe.config" src="http://images.wadewegner.com/wordpress/content/binary/WindowsLiveWriter/e8c3b063ce21_A687/image_thumb.png" width="240" height="152" /></a> </p>

<p>Simply add the <font face="courier new">&lt;system.net&gt; ... &lt;/system.net&gt;</font> XML to the configuration file and then restart your host instances.&#160; This will allow you to issue more than two concurrent requests to any given web server.</p>

<p>I hope this helps save you some time you would have otherwise lost!</p>
